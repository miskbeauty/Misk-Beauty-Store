<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | مسك بيوتي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Quill.js for Rich Text -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/admin.css">
</head>

<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar">
            <div class="sidebar-logo">
                <img src="assets/images/1745215944148877862-removebg-preview.png" alt="Misk Beauty Logo">
                <h3 style="color: #6a1b9a; font-size: 0.9rem; margin-top: 10px;">إدارة مسك بيوتي</h3>
            </div>

            <ul class="sidebar-menu">
                <li class="menu-item active" id="menu-orders">
                    <a href="#" onclick="switchTab('orders')">
                        <i class="fas fa-shopping-bag"></i>
                        <span>إدارة الطلبات</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-products">
                    <a href="#" onclick="switchTab('products')">
                        <i class="fas fa-box-open"></i>
                        <span>إدارة المنتجات</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-categories">
                    <a href="#" onclick="switchTab('categories')">
                        <i class="fas fa-list-ul"></i>
                        <span>إدارة التصنيفات</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-customers">
                    <a href="#" onclick="switchTab('customers')">
                        <i class="fas fa-users"></i>
                        <span>العملاء</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-reviews">
                    <a href="#" onclick="switchTab('reviews')">
                        <i class="fas fa-star"></i>
                        <span>التقييمات والمراجعات</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-pages">
                    <a href="#" onclick="switchTab('pages')">
                        <i class="fas fa-file-alt"></i>
                        <span>إدارة الصفحات</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-analytics">
                    <a href="#" onclick="switchTab('analytics')">
                        <i class="fas fa-chart-bar"></i>
                        <span>التقارير والإحصائيات</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-settings">
                    <a href="#" onclick="switchTab('settings')">
                        <i class="fas fa-cog"></i>
                        <span>الإعدادات</span>
                    </a>
                </li>
                <li class="menu-item" style="margin-top: 50px;">
                    <a href="admin-login.html" onclick="localStorage.removeItem('misk_admin_session')">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>تسجيل الخروج</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content Area -->
        <main class="admin-main">
            <!-- Top Header -->
            <header class="dashboard-header">
                <div>
                    <h1 style="font-size: 1.8rem; font-weight: 700;">أهلاً بك، المدير</h1>
                    <p style="color: #636e72;">نظرة عامة على نشاط المتجر اليوم.</p>
                </div>

                <div class="admin-user-info">
                    <div class="user-details" style="text-align: left;">
                        <span style="display: block; font-weight: 700;">أحمد محمد</span>
                        <span style="font-size: 0.8rem; color: #888;">مدير المتجر</span>
                    </div>
                    <div class="user-avatar">AD</div>
                </div>
            </header>

            <!-- Quick Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-purple">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-info">
                        <h4>إجمالي الطلبات</h4>
                        <span>124</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon bg-pink">
                        <i class="fas fa-shekel-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h4>المبيعات (شيكل)</h4>
                        <span>4,820</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon bg-gold">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="stat-info">
                        <h4>زوار اليوم</h4>
                        <span>352</span>
                    </div>
                </div>
            </section>

            <!-- Orders Management Table -->
            <section id="orders-section" class="admin-card">
                <div class="card-header">
                    <h3 style="font-weight: 700;">إدارة الطلبات</h3>
                    <div class="header-actions">
                        <button class="btn-admin-login"
                            style="padding: 8px 15px; font-size: 0.9rem; width: auto; box-shadow: none;">تصدير
                            البيانات</button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>التاريخ</th>
                                <th>الاسم</th>
                                <th>المنطقة/المدينة</th>
                                <th>الإجمالي</th>
                                <th>الحالة</th>
                                <th>العمليات</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Product Management Table -->
            <section id="products-section" class="admin-card hidden">
                <div class="card-header">
                    <h3 style="font-weight: 700;">إدارة المنتجات</h3>
                    <div class="header-actions">
                        <button onclick="openProductModal()" class="btn-admin-login"
                            style="padding: 8px 15px; font-size: 0.9rem; width: auto; box-shadow: none;">
                            <i class="fas fa-plus"></i> إضافة منتج جديد
                        </button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>صورة المنتج</th>
                                <th>الاسم</th>
                                <th>التصنيف</th>
                                <th>السعر</th>
                                <th>المخزون</th>
                                <th>العمليات</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Category Management Table -->
            <section id="categories-section" class="admin-card hidden">
                <!-- ... existing content ... -->
                <div class="card-header">
                    <h3 style="font-weight: 700;">إدارة التصنيفات</h3>
                    <div class="header-actions">
                        <button onclick="openCategoryModal()" class="btn-admin-login"
                            style="padding: 8px 15px; font-size: 0.9rem; width: auto; box-shadow: none;">
                            <i class="fas fa-plus"></i> إضافة تصنيف جديد
                        </button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>أيقونة/صورة</th>
                                <th>الاسم</th>
                                <th>التصنيف الأب</th>
                                <th>في الهيدر</th>
                                <th>الأولوية</th>
                                <th>العمليات</th>
                            </tr>
                        </thead>
                        <tbody id="categories-table-body">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Customers Management Table -->
            <section id="customers-section" class="admin-card hidden">
                <div class="card-header">
                    <h3 style="font-weight: 700;">إدارة العملاء</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>اسم العميل</th>
                                <th>رقم الهاتف</th>
                                <th>النوع</th>
                                <th>الحالة</th>
                                <th>نقاط الولاء</th>
                                <th>إجمالي الإنفاق (شيكل)</th>
                                <th>آخر طلب</th>
                                <th>العمليات</th>
                            </tr>
                        </thead>
                        <tbody id="customers-table-body">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reviews Moderation Table -->
            <section id="reviews-section" class="admin-card hidden">
                <div class="card-header">
                    <h3 style="font-weight: 700;">إدارة التقييمات</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>العميل</th>
                                <th>التقييم</th>
                                <th>التعليق</th>
                                <th>الصور</th>
                                <th>الحالة</th>
                                <th>العمليات</th>
                            </tr>
                        </thead>
                        <tbody id="reviews-table-body">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Analytics & Reports Section -->
            <section id="analytics-section" class="admin-card hidden">
                <div class="card-header">
                    <h3 style="font-weight: 700;">التقارير والإحصائيات</h3>
                    <div class="header-actions">
                        <button onclick="exportSalesDataCSV()" class="btn-admin-login"
                            style="padding: 8px 15px; font-size: 0.9rem; width: auto; box-shadow: none; background: #2e7d32;">
                            <i class="fas fa-file-excel"></i> تصدير البيانات (CSV)
                        </button>
                    </div>
                </div>

                <!-- Stats Cards Grid -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-icon bg-purple">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <div class="stat-info">
                            <h4>إجمالي المبيعات</h4>
                            <span id="ana-total-revenue">0 شيكل</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-pink">
                            <i class="fas fa-shopping-basket"></i>
                        </div>
                        <div class="stat-info">
                            <h4>إجمالي الطلبات</h4>
                            <span id="ana-order-count">0</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-gold">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h4>متوسط قيمة الطلب</h4>
                            <span id="ana-aov">0 شيكل</span>
                        </div>
                    </div>
                </div>

                <div class="details-grid">
                    <!-- Top Selling Products -->
                    <div class="admin-card" style="box-shadow: none; border: 1px solid #eee;">
                        <h4 style="margin-bottom: 15px; color: var(--admin-purple);"><i class="fas fa-trophy"></i>
                            الأكثر مبيعاً (منتجات)</h4>
                        <ul id="ana-top-products" style="list-style: none; padding: 0;">
                            <!-- Data populated by JS -->
                        </ul>
                    </div>

                    <!-- Category Performance -->
                    <div class="admin-card" style="box-shadow: none; border: 1px solid #eee;">
                        <h4 style="margin-bottom: 15px; color: var(--admin-purple);"><i class="fas fa-chart-pie"></i>
                            مبيعات التصنيفات</h4>
                        <ul id="ana-top-categories" style="list-style: none; padding: 0;">
                            <!-- Data populated by JS -->
                        </ul>
                    </div>

                    <!-- Loyalty Insights -->
                    <div class="admin-card full-width"
                        style="box-shadow: none; border: 1px solid #eee; margin-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--admin-purple);"><i class="fas fa-gift"></i> تقارير
                            نظام الولاء</h4>
                        <div
                            style="display: flex; gap: 40px; align-items: center; justify-content: center; padding: 20px;">
                            <div style="text-align: center;">
                                <p style="color: #888; margin-bottom: 5px;">النقاط المكتسبة</p>
                                <h3 id="ana-points-earned" style="color: #6a1b9a;">0</h3>
                            </div>
                            <div style="font-size: 2rem; color: #eee;">|</div>
                            <div style="text-align: center;">
                                <p style="color: #888; margin-bottom: 5px;">النقاط المستبدلة</p>
                                <h3 id="ana-points-redeemed" style="color: #d81b60;">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="admin-card hidden">
                <div class="card-header">
                    <h3 style="font-weight: 700;">إعدادات المتجر</h3>
                </div>

                <form id="settings-form" onsubmit="handleSettingsSubmit(event)">
                    <div class="details-grid">
                        <div class="admin-form-group">
                            <label>اسم المتجر</label>
                            <input type="text" id="set-store-name" class="admin-input" placeholder="مثلاً: مسك بيوتي">
                        </div>
                        <div class="admin-form-group">
                            <label>رقم الواتساب (للتواصل والطلبات)</label>
                            <input type="text" id="set-whatsapp" class="admin-input" placeholder="+970xxxxxxxxx">
                        </div>
                        <div class="admin-form-group">
                            <label>رابط انستجرام</label>
                            <input type="text" id="set-instagram" class="admin-input"
                                placeholder="https://instagram.com/...">
                        </div>
                        <div class="admin-form-group">
                            <label>رابط تيك توك</label>
                            <input type="text" id="set-tiktok" class="admin-input" placeholder="https://tiktok.com/...">
                        </div>
                        <div class="admin-form-group full-width">
                            <label>شعار المتجر (Logo)</label>
                            <input type="file" id="set-logo-input" class="admin-input" accept="image/*"
                                onchange="previewLogo(this)">
                            <div id="logo-preview" style="margin-top: 10px;"></div>
                        </div>

                        <div class="full-width"
                            style="margin-top: 20px; border-top: 2px solid #f0f0f0; padding-top: 20px;">
                            <h4 style="color: var(--admin-purple); margin-bottom: 15px;">إعدادات الشحن وتكاليف التوصيل
                            </h4>
                        </div>

                        <div class="admin-form-group">
                            <label>حد الشحن المجاني (شيكل)</label>
                            <input type="number" id="set-free-shipping-threshold" class="admin-input" placeholder="300">
                        </div>
                        <div class="admin-form-group">
                            <label>رابط فيسبوك</label>
                            <input type="text" id="set-facebook" class="admin-input"
                                placeholder="https://facebook.com/...">
                        </div>
                        <div class="admin-form-group full-width">
                            <label>وصف المتجر (يظهر في التذييل)</label>
                            <textarea id="set-store-desc" class="admin-input" style="min-height: 80px;"
                                placeholder="اكتب وصفاً مختصراً لمتجرك في التذييل..."></textarea>
                        </div>

                        <div class="full-width"
                            style="margin-top: 20px; border-top: 2px solid #f0f0f0; padding-top: 20px;">
                            <h4 style="color: var(--admin-purple); margin-bottom: 15px;">إعدادات نظام الولاء (Loyalty
                                Settings)</h4>
                        </div>
                        <div class="admin-form-group">
                            <label>مدة صلاحية النقاط (بالأيام)</label>
                            <input type="number" id="set-points-expiry" class="admin-input" placeholder="365">
                        </div>
                        <div class="admin-form-group">
                            <label>نقاط مكافأة التقييم</label>
                            <input type="number" id="set-points-review" class="admin-input" placeholder="50">
                        </div>

                        <div class="full-width"
                            style="margin-top: 20px; border-top: 2px solid #f0f0f0; padding-top: 20px;">
                            <h4 style="color: var(--admin-purple); margin-bottom: 15px;">إعدادات الأرشفة والـ SEO
                                (Advanced SEO)</h4>
                        </div>

                        <div class="admin-form-group full-width">
                            <label>عنوان المتجر الافتراضي (Meta Title)</label>
                            <input type="text" id="set-meta-title" class="admin-input"
                                placeholder="مثلاً: مسك بيوتي | لمنتجات العناية والجمال">
                        </div>
                        <div class="admin-form-group full-width">
                            <label>وصف المتجر لمحركات البحث (Meta Description)</label>
                            <textarea id="set-meta-desc" class="admin-input" style="min-height: 80px;"
                                placeholder="اكتب وصفاً جذاباً يظهر في نتائج البحث..."></textarea>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>الكلمات المفتاحية (SEO Keywords)</label>
                            <input type="text" id="set-meta-keywords" class="admin-input"
                                placeholder="مسك, عطور, تجميل, عناية, فلسطين">
                        </div>

                        <div class="full-width"
                            style="margin-top: 20px; border-top: 2px solid #f0f0f0; padding-top: 20px;">
                            <h4 style="color: var(--admin-purple); margin-bottom: 15px;">إدارة المحتوى القانوني (Legal
                                Pages)</h4>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>سياسة الخصوصية (Privacy Policy)</label>
                            <div id="privacy-editor-container" style="height: 150px; background: #fff;"></div>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>شروط الاستخدام (Terms of Use)</label>
                            <div id="terms-editor-container" style="height: 150px; background: #fff;"></div>
                        </div>
                    </div>

                    <div style="margin-top: 30px; text-align: left;">
                        <button type="submit" class="btn-admin-login" style="width: auto; padding: 12px 40px;">حفظ
                            الإعدادات</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-order-number">تفاصيل الطلب</h3>
                <button class="close-modal" onclick="closeModal('order-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">اسم العميل</span>
                        <span class="detail-value" id="detail-name">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">رقم الواتساب</span>
                        <span class="detail-value" id="detail-whatsapp">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">المدينة/المنطقة</span>
                        <span class="detail-value" id="detail-city">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">التاريخ</span>
                        <span class="detail-value" id="detail-date">-</span>
                    </div>
                    <div class="detail-item full-width">
                        <span class="detail-label">العنوان بالتفصيل</span>
                        <span class="detail-value" id="detail-address">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">المبلغ الإجمالي</span>
                        <span class="detail-value" id="detail-total">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">الحالة الحالية</span>
                        <span id="detail-status-badge" class="status-badge">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Modal -->
    <div id="page-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="page-modal-title" style="margin-bottom: 20px; color: #6a1b9a;">إضافة صفحة جديدة</h2>
            <form id="page-form" onsubmit="handlePageSubmit(event)">
                <input type="hidden" id="page-id">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="page-title">عنوان الصفحة</label>
                        <input type="text" id="page-title" required placeholder="مثلاً: من نحن">
                    </div>
                    <div class="form-group">
                        <label for="page-slug">الرابط البديل (Slug)</label>
                        <input type="text" id="page-slug" required placeholder="مثلاً: about-us">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="page-is-active" style="width: auto;">
                    <label for="page-is-active" style="margin-bottom: 0;">عرض هذه الصفحة في الموقع (نشط)</label>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>محتوى الصفحة</label>
                    <div id="page-editor" style="height: 300px; background: white;"></div>
                </div>
                <div class="modal-footer" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('page-modal')">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ الصفحة</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Modal (Add/Edit) -->
    <div id="product-modal" class="modal-overlay">
        <!-- ... existing product modal content ... -->
        <div class="modal-content" style="max-width: 850px;">
            <div class="modal-header">
                <h3 id="product-modal-title">إضافة منتج جديد</h3>
                <button class="close-modal" onclick="closeModal('product-modal')">&times;</button>
            </div>
            <form id="product-form" onsubmit="handleProductSubmit(event)">
                <input type="hidden" id="product-id">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 10px;">
                    <div class="details-grid">
                        <!-- ... existing grid content ... -->
                        <div class="admin-form-group">
                            <label>اسم المنتج</label>
                            <input type="text" id="prod-name" class="admin-input" required
                                placeholder="مثلاً: عطر مسك فاخر">
                        </div>
                        <div class="admin-form-group">
                            <label>عنوان الميتا (Meta Title)</label>
                            <input type="text" id="prod-meta-title" class="admin-input"
                                placeholder="مثلاً: عطر مسك فاخر | متجر مسك">
                        </div>
                        <div class="admin-form-group">
                            <label>رابط SEO (Slug)</label>
                            <input type="text" id="prod-slug" class="admin-input"
                                placeholder="مثلاً: luxury-musk-perfume">
                        </div>
                        <div class="admin-form-group full-width">
                            <label>وصف الميتا (SEO Meta Description)</label>
                            <textarea id="prod-meta-desc" class="admin-input" style="min-height: 60px;"
                                placeholder="اكتب وصفاً مختصراً يظهر في محركات البحث..."></textarea>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>صور المنتج (يمكنك اختيار عدة صور)</label>
                            <div class="image-upload-wrapper">
                                <input type="file" id="prod-images-input" class="admin-input" accept="image/*" multiple
                                    onchange="previewImages(this)">
                                <div id="image-preview-container" class="image-preview-grid"></div>
                            </div>
                        </div>
                        <div class="admin-form-group">
                            <label>السعر الأصلي (شيكل)</label>
                            <input type="number" id="prod-original-price" class="admin-input" placeholder="120">
                        </div>
                        <div class="admin-form-group">
                            <label>سعر العرض (شيكل)</label>
                            <input type="number" id="prod-price" class="admin-input" required placeholder="99">
                        </div>
                        <div class="admin-form-group">
                            <label>المخزون الإجمالي</label>
                            <input type="number" id="prod-stock" class="admin-input" required placeholder="50">
                        </div>
                        <div class="admin-form-group">
                            <label>أولوية الظهور (Priority)</label>
                            <input type="number" id="prod-priority" class="admin-input" value="0">
                        </div>
                        <div class="admin-form-group">
                            <label>التصنيف الرئيسي</label>
                            <select id="prod-category" class="admin-input" required>
                                <option value="عناية وجمال">عناية وجمال</option>
                                <option value="عطور">عطور</option>
                                <option value="شنط وإكسسوارات">شنط وإكسسوارات</option>
                                <option value="الأطفال والبيبي">الأطفال والبيبي</option>
                                <option value="الطباعة الحرارية">الطباعة الحرارية</option>
                                <option value="منتجات طبية">منتجات طبية</option>
                                <option value="المنزل والديكور">المنزل والديكور</option>
                                <option value="الهدايا">الهدايا</option>
                            </select>
                        </div>
                        <div class="admin-form-group">
                            <label>التصنيف الفرعي</label>
                            <select id="prod-sub-category" class="admin-input" onchange="syncParentCategory()">
                                <option value="">بدون تصنيف فرعي</option>
                                <optgroup label="عناية وجمال">
                                    <option value="مكياج">مكياج</option>
                                    <option value="عناية بالبشرة">عناية بالبشرة</option>
                                    <option value="شعر">شعر</option>
                                    <option value="جسم">جسم</option>
                                </optgroup>
                                <optgroup label="عطور">
                                    <option value="ستاتي">ستاتي</option>
                                    <option value="رجالي">رجالي</option>
                                    <option value="مزيل عرق">مزيل عرق</option>
                                    <option value="عطر شعر">عطر شعر</option>
                                    <option value="بخور">بخور</option>
                                </optgroup>
                                <optgroup label="شنط وإكسسوارات">
                                    <option value="شنط">شنط</option>
                                    <option value="إكسسوارات ستاتي">إكسسوارات ستاتي</option>
                                    <option value="رجالي">إكسسوارات رجالي</option>
                                </optgroup>
                                <optgroup label="الأطفال والبيبي">
                                    <option value="مستلزمات">مستلزمات</option>
                                    <option value="إكسسوارات">إكسسوارات بيبي</option>
                                </optgroup>
                                <optgroup label="الطباعة الحرارية">
                                    <option value="براويز">براويز</option>
                                    <option value="مجات">مجات</option>
                                    <option value="لهايات وبلايز">لهايات وبلايز</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="admin-form-group full-width"
                            style="margin-top: 20px; border-top: 2px solid #f0f0f0; padding-top: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: var(--admin-purple);">تعدد الخيارات (Variants)</h4>
                                <button type="button" onclick="addVariantItem()" class="btn-cancel"
                                    style="padding: 5px 15px; font-size: 0.85rem; background: var(--admin-purple); color: white;">
                                    <i class="fas fa-plus"></i> إضافة خيار محدد (درجة/لون)
                                </button>
                            </div>
                            <div id="variants-v2-container">
                                <div id="variants-header"
                                    style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 40px; gap: 10px; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; color: #777;">
                                    <span>اسم الخيار (مثلاً: درجة 1)</span>
                                    <span>سعر أصلي</span>
                                    <span>سعر عرض</span>
                                    <span>مخزون</span>
                                    <span>SKU</span>
                                    <span></span>
                                </div>
                                <div id="variant-items-list"></div>
                            </div>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>وصف المنتج التفصيلي (طريقة الاستخدام، المكونات، إلخ)</label>
                            <div id="editor-container" style="height: 200px; background: #fff;"></div>
                            <textarea id="prod-desc" style="display:none;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('product-modal')">إلغاء</button>
                    <button type="submit" class="btn-admin-login" style="width: auto; padding: 10px 30px;">حفظ
                        المنتج</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal (Add/Edit) -->
    <div id="category-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 850px;">
            <div class="modal-header">
                <h3 id="category-modal-title">إضافة تصنيف جديد</h3>
                <button class="close-modal" onclick="closeModal('category-modal')">&times;</button>
            </div>
            <form id="category-form" onsubmit="handleCategorySubmit(event)">
                <input type="hidden" id="category-id">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 10px;">
                    <div class="details-grid">
                        <div class="admin-form-group">
                            <label>اسم التصنيف</label>
                            <input type="text" id="cat-name" class="admin-input" required
                                placeholder="مثلاً: عطور فرنسية">
                        </div>
                        <div class="admin-form-group">
                            <label>رابط (Slug) SEO</label>
                            <input type="text" id="cat-slug" class="admin-input"
                                placeholder="اختياري - سيتم توليده تلقائياً">
                        </div>
                        <div class="admin-form-group">
                            <label>التصنيف الأب (Hierarchy)</label>
                            <select id="cat-parent" class="admin-input">
                                <option value="">بدون (تصنيف رئيسي)</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="admin-form-group">
                            <label>أولوية الترتيب</label>
                            <input type="number" id="cat-priority" class="admin-input" value="0">
                        </div>
                        <div class="admin-form-group">
                            <label>ظهور في الهيدر الرئيسي؟</label>
                            <select id="cat-show-header" class="admin-input">
                                <option value="true">نعم</option>
                                <option value="false">لا</option>
                            </select>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>صورة التصنيف</label>
                            <input type="file" id="cat-image-input" class="admin-input" accept="image/*"
                                onchange="previewCatImage(this)">
                            <div id="cat-image-preview" style="margin-top: 10px;"></div>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>محتوى رأس القسم (SEO & Static Content)</label>
                            <div id="cat-editor-container" style="height: 150px; background: #fff;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('category-modal')">إلغاء</button>
                    <button type="submit" class="btn-admin-login" style="width: auto; padding: 10px 30px;">حفظ
                        التصنيف</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quill.js scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        let quill;
        let catQuill;
        let privacyQuill;
        let termsQuill;
        let uploadedImagesBase64 = [];
        let catImageBase64 = null;
        let mockCategories = [];
        let mockCustomers = [];

        document.addEventListener('DOMContentLoaded', () => {
            // --- Admin Auth Guard ---
            const session = localStorage.getItem('misk_admin_session');
            if (!session) {
                console.error("Unauthorized access, redirecting to login...");
                window.location.href = 'admin-login.html';
                return;
            }

            // Init Product Editor
            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'direction': 'rtl' }, { 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'اكتب وصف المنتج هنا...'
            });

            // Init Category Editor
            catQuill = new Quill('#cat-editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'المحتوى الذي سيظهر في رأس الصفحة...'
            });

            // Init Privacy Editor
            privacyQuill = new Quill('#privacy-editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'bullet' }], ['clean']]
                },
                placeholder: 'اكتب سياسة الخصوصية هنا...'
            });

            // Init Terms Editor
            termsQuill = new Quill('#terms-editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'bullet' }], ['clean']]
                },
                placeholder: 'اكتب شروط الاستخدام هنا...'
            });

            // Unified Initialization
            initDashboard();
        });

        function escapeHTML(str) {
            if (!str) return "";
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Data Protection Helper ---
        const DataVault = {
            encrypt: (data) => btoa(encodeURIComponent(JSON.stringify(data))), // Basic obfuscation for demo
            decrypt: (secret) => {
                if (!secret) return null;
                try {
                    return JSON.parse(decodeURIComponent(atob(secret)));
                } catch (e) {
                    return null;
                }
            }
        };

        // --- Multi-Image Logic ---
        function previewImages(input) {
            const container = document.getElementById('image-preview-container');
            container.innerHTML = '';
            uploadedImagesBase64 = [];

            if (input.files) {
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        uploadedImagesBase64.push(e.target.result);
                        const div = document.createElement('div');
                        div.className = 'preview-item';
                        div.innerHTML = `
                            <img src="${e.target.result}">
                            <button type="button" onclick="removePreview(this, '${e.target.result}')" class="remove-p">&times;</button>
                        `;
                        container.appendChild(div);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        function removePreview(btn, src) {
            uploadedImagesBase64 = uploadedImagesBase64.filter(img => img !== src);
            btn.parentElement.remove();
        }

        // --- Category Image Logic ---
        function previewCatImage(input) {
            const container = document.getElementById('cat-image-preview');
            container.innerHTML = '';
            catImageBase64 = null;

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    catImageBase64 = e.target.result;
                    container.innerHTML = `<img src="${catImageBase64}" style="max-width: 100px; border-radius: 8px;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- Variants Logic v2 ---
        function addVariantItem(data = {}) {
            const list = document.getElementById('variant-items-list');
            const div = document.createElement('div');
            div.className = 'variant-v2-row';
            div.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 40px; gap: 10px; margin-bottom: 10px; align-items: center;';

            div.innerHTML = `
                <input type="text" class="admin-input var-v2-label" placeholder="درجة 1" value="${data.label || ''}">
                <input type="number" class="admin-input var-v2-orig" placeholder="0" value="${data.originalPrice || ''}">
                <input type="number" class="admin-input var-v2-price" placeholder="0" value="${data.price || ''}">
                <input type="number" class="admin-input var-v2-stock" placeholder="0" value="${data.stock || ''}">
                <input type="text" class="admin-input var-v2-sku" placeholder="SKU" value="${data.sku || ''}">
                <button type="button" onclick="this.parentElement.remove()" style="color: red; background: none; border: none; font-size: 1.2rem; cursor: pointer;">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            list.appendChild(div);
        }

        function getVariantsData() {
            const rows = document.querySelectorAll('.variant-v2-row');
            const variants = [];
            rows.forEach(row => {
                const label = row.querySelector('.var-v2-label').value.trim();
                const originalPrice = row.querySelector('.var-v2-orig').value;
                const price = row.querySelector('.var-v2-price').value;
                const stock = row.querySelector('.var-v2-stock').value;
                const sku = row.querySelector('.var-v2-sku').value.trim();

                if (label) {
                    variants.push({
                        label,
                        originalPrice: originalPrice ? parseInt(originalPrice) : null,
                        price: price ? parseInt(price) : 0,
                        stock: stock ? parseInt(stock) : 0,
                        sku
                    });
                }
            });
            return variants;
        }

        // --- Mock Data ---
        let mockOrders = [
            { id: "10521", date: "2024-01-29", customer: "ياسر الأحمد", whatsapp: "+970 599 123 456", city: "عقربا، نابلس", address: "شارع المدارس، عمارة الأمل، ط2", total: "120 شيكل", status: "waiting" },
            { id: "10522", date: "2024-01-28", customer: "سارة محمود", whatsapp: "+970 568 987 654", city: "القدس، شارع الزهراء", address: "فوق صيدلية القدس، شقة 4", total: "315 شيكل", status: "preparing" }
        ];

        let mockProducts = [
            { id: 1, name: "عطر مسك فاخر", category: "عطور", price: 85, stock: 24, images: ["assets/images/perfume-sample.jpg"], variants: [] }
        ];

        const statusMap = {
            'waiting': 'بانتظار التأكيد',
            'preparing': 'قيد التجهيز',
            'shipped': 'تم الشحن',
            'delivered': 'تم التوصيل'
        };

        // --- Core Functions ---
        function switchTab(tab) {
            const sections = ['orders-section', 'products-section', 'categories-section', 'customers-section', 'reviews-section', 'analytics-section', 'settings-section'];
            const menuItems = ['menu-orders', 'menu-products', 'menu-categories', 'menu-customers', 'menu-reviews', 'menu-analytics', 'menu-settings'];

            sections.forEach(s => {
                const el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            menuItems.forEach(m => {
                const el = document.getElementById(m);
                if (el) el.classList.remove('active');
            });

            const targetSection = document.getElementById(`${tab}-section`);
            const targetMenu = document.getElementById(`menu-${tab}`);

            if (targetSection) targetSection.classList.remove('hidden');
            if (targetMenu) targetMenu.classList.add('active');

            if (tab === 'orders') renderOrders();
            if (tab === 'products') renderProducts();
            if (tab === 'categories') renderCategories();
            if (tab === 'customers') renderCustomers();
            if (tab === 'reviews') renderReviewsModeration();
            if (tab === 'analytics') renderAnalytics();
            if (tab === 'settings') renderSettings();
        }

        function getLoyaltyStatus(points) {
            if (points > 1500) return { label: 'ذهبي (VIP)', class: 'status-gold' };
            if (points > 500) return { label: 'فضي', class: 'status-silver' };
            return { label: 'برونزي', class: 'status-bronze' };
        }

        // --- Points Expiration & Cleanup ---
        function cleanupCustomerPoints(cust, expiryDays) {
            if (!cust.pointsHistory || !expiryDays) return cust;

            const now = new Date();
            const originalPoints = cust.points || 0;

            // Filter out expired points
            cust.pointsHistory = cust.pointsHistory.filter(p => {
                const earnedDate = new Date(p.date);
                const diffTime = Math.abs(now - earnedDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= expiryDays;
            });

            // Recalculate total points
            cust.points = cust.pointsHistory.reduce((sum, p) => sum + p.amount, 0);

            if (cust.points !== originalPoints) {
                console.log(`تم تنظيف نقاط منتهية للعميل ${cust.name}`);
            }
            return cust;
        }

        function renderReviewsModeration() {
            const tableBody = document.getElementById('reviews-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const encryptedReviews = localStorage.getItem('misk_reviews_vault');
            const reviews = DataVault.decrypt(encryptedReviews) || [];

            if (reviews.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">لا توجد تقييمات حالياً.</td></tr>';
                return;
            }

            // Sort by pending first, then date desc
            reviews.sort((a, b) => {
                if (a.status === 'pending' && b.status !== 'pending') return -1;
                if (a.status !== 'pending' && b.status === 'pending') return 1;
                return new Date(b.date) - new Date(a.date);
            });

            reviews.forEach((rev, index) => {
                const tr = document.createElement('tr');
                const stars = '⭐'.repeat(rev.rating);
                const product = mockProducts.find(p => p.id == rev.productId);
                const productName = product ? product.name : 'منتج غير معروف';

                let imageGallery = '';
                if (rev.images && rev.images.length > 0) {
                    imageGallery = rev.images.map(img => `<img src="${img}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover; margin-left: 5px;">`).join('');
                } else {
                    imageGallery = '<span style="color: #ccc;">بدون صور</span>';
                }

                const statusClass = rev.status === 'approved' ? 'status-paid' : (rev.status === 'rejected' ? 'status-cancelled' : 'status-waiting');
                const statusLabel = rev.status === 'approved' ? 'معتمد' : (rev.status === 'rejected' ? 'مرفوض' : 'قيد الانتظار');

                tr.innerHTML = `
                    <td>${productName}</td>
                    <td>${rev.userName}<br><small style="color: #888;">${rev.userPhone}</small></td>
                    <td>${stars}</td>
                    <td style="max-width: 200px; white-space: normal;">${rev.text}</td>
                    <td>${imageGallery}</td>
                    <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                    <td>
                        ${rev.status === 'pending' ? `
                            <button onclick="approveReview('${rev.id}')" class="btn-admin-login" style="padding: 5px 10px; font-size: 0.8rem; width: auto; background: #4CAF50;">قَبول</button>
                            <button onclick="rejectReview('${rev.id}')" class="btn-cancel" style="padding: 5px 10px; font-size: 0.8rem; width: auto; background: #e91e63; color: white; border: none;">رفض</button>
                        ` : `
                            <button onclick="deleteReview('${rev.id}')" style="background:none; border:none; cursor:pointer; color: #d32f2f;"><i class="fas fa-trash"></i></button>
                        `}
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function approveReview(reviewId) {
            const encryptedReviews = localStorage.getItem('misk_reviews_vault');
            const reviews = DataVault.decrypt(encryptedReviews) || [];
            const revIndex = reviews.findIndex(r => r.id == reviewId);

            if (revIndex === -1) return;
            const rev = reviews[revIndex];

            // 1. Mark as approved
            rev.status = 'approved';
            localStorage.setItem('misk_reviews_vault', DataVault.encrypt(reviews));

            // 2. Grant Loyalty Points
            const savedSettings = localStorage.getItem('misk_settings');
            const settings = savedSettings ? JSON.parse(savedSettings) : {};
            const pointsReward = settings.pointsPerReview || 50;

            const encryptedUsers = localStorage.getItem('misk_users_vault');
            const users = DataVault.decrypt(encryptedUsers) || [];
            const user = users.find(u => u.phone === rev.userPhone);

            if (user) {
                user.points = (user.points || 0) + pointsReward;
                if (!user.pointsHistory) user.pointsHistory = [];
                user.pointsHistory.push({
                    amount: pointsReward,
                    date: new Date().toISOString().split('T')[0],
                    reason: `مكافأة تقييم منتج: ${rev.productId}`
                });
                localStorage.setItem('misk_users_vault', DataVault.encrypt(users));
                console.log(`تم منح ${pointsReward} نقطة للمستخدم ${user.name}`);
            }

            alert('تم اعتماد التقييم ومنح العميل النقاط بنجاح.');
            renderReviewsModeration();
        }

        function rejectReview(reviewId) {
            if (!confirm('هل أنت متأكد من رفض هذا التقييم؟')) return;
            const encryptedReviews = localStorage.getItem('misk_reviews_vault');
            const reviews = DataVault.decrypt(encryptedReviews) || [];
            const rev = reviews.find(r => r.id == reviewId);
            if (rev) {
                rev.status = 'rejected';
                localStorage.setItem('misk_reviews_vault', DataVault.encrypt(reviews));
                renderReviewsModeration();
            }
        }

        function deleteReview(reviewId) {
            if (!confirm('هل أنت متأكد من حذف هذا التقييم نهائياً؟')) return;
            const encryptedReviews = localStorage.getItem('misk_reviews_vault');
            const reviews = DataVault.decrypt(encryptedReviews) || [];
            const filtered = reviews.filter(r => r.id != reviewId);
            localStorage.setItem('misk_reviews_vault', DataVault.encrypt(filtered));
            renderReviewsModeration();
        }

        function getExpiringSoonStatus(cust, expiryDays) {
            if (!cust.pointsHistory || !expiryDays) return false;
            const now = new Date();
            const threshold = 30; // 30 days alert

            return cust.pointsHistory.some(p => {
                const earnedDate = new Date(p.date);
                const diffTime = Math.abs(now - earnedDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const daysLeft = expiryDays - diffDays;
                return daysLeft >= 0 && daysLeft <= threshold;
            });
        }

        function renderCustomers() {
            const tableBody = document.getElementById('customers-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const encryptedCustomers = localStorage.getItem('misk_customers_vault');
            let customers = DataVault.decrypt(encryptedCustomers) || [];

            const savedSettings = localStorage.getItem('misk_settings');
            const settings = savedSettings ? JSON.parse(savedSettings) : {};
            const expiryDays = settings.pointsExpiryDays || 365;

            if (customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">لا يوجد عملاء متاحين حالياً.</td></tr>';
                return;
            }

            // Cleanup & Update
            let updated = false;
            customers = customers.map(c => {
                const oldPoints = c.points;
                const cleaned = cleanupCustomerPoints(c, expiryDays);
                if (cleaned.points !== oldPoints) updated = true;
                return cleaned;
            });

            if (updated) {
                localStorage.setItem('misk_customers_vault', DataVault.encrypt(customers));
            }

            // Sort by total spend descending
            customers.sort((a, b) => b.totalSpend - a.totalSpend);

            customers.forEach(cust => {
                const points = cust.points || 0;
                const status = getLoyaltyStatus(points);
                const expiringSoon = getExpiringSoonStatus(cust, expiryDays);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cust.name}</td>
                    <td>${cust.phone}</td>
                    <td>${cust.isRegistered ? '<span style="color: var(--admin-purple); font-weight: bold;"><i class="fas fa-user-check"></i> عضو</span>' : '<span style="color: #888;"><i class="fas fa-user"></i> زائر</span>'}</td>
                    <td><span class="status-badge ${status.class}">${status.label}</span></td>
                    <td style="font-weight: bold; color: var(--admin-purple); position: relative;">
                        ${points} نقطة
                        ${expiringSoon ? `<i class="fas fa-exclamation-triangle" title="توجد نقاط ستنتهي خلال 30 يوماً" style="color: #ff9800; margin-right: 5px; cursor: help;"></i>` : ''}
                    </td>
                    <td>${cust.totalSpend} شيكل</td>
                    <td>${cust.lastOrderDate}</td>
                    <td>
                        <button onclick="redeemPoints('${cust.phone}')" class="btn-admin-login" 
                            style="padding: 5px 10px; font-size: 0.8rem; width: auto; background: var(--admin-purple);"
                            ${points < 100 ? 'disabled title="يحتاج 100 نقطة على الأقل"' : ''}>
                            تحويل لنقاط
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function redeemPoints(phone) {
            const encryptedCustomers = localStorage.getItem('misk_customers_vault');
            const customers = DataVault.decrypt(encryptedCustomers) || [];
            const cust = customers.find(c => c.phone === phone);

            if (cust && (cust.points || 0) >= 100) {
                if (confirm(`هل تريد تحويل 100 نقطة من حساب ${cust.name} إلى قسيمة شراء بقيمة 10 شيكل؟`)) {
                    // FIFO Deduction
                    let pointsToDeduct = 100;
                    if (!cust.pointsHistory) cust.pointsHistory = [{ amount: cust.points, date: new Date().toISOString().split('T')[0] }];

                    // Sort history by date (oldest first)
                    cust.pointsHistory.sort((a, b) => new Date(a.date) - new Date(b.date));

                    while (pointsToDeduct > 0 && cust.pointsHistory.length > 0) {
                        const oldest = cust.pointsHistory[0];
                        if (oldest.amount > pointsToDeduct) {
                            oldest.amount -= pointsToDeduct;
                            pointsToDeduct = 0;
                        } else {
                            pointsToDeduct -= oldest.amount;
                            cust.pointsHistory.shift();
                        }
                    }

                    // Recalculate total points
                    cust.points = cust.pointsHistory.reduce((sum, p) => sum + p.amount, 0);

                    localStorage.setItem('misk_customers_vault', DataVault.encrypt(customers));
                    const coupon = 'LOYAL-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                    alert(`تم تحويل النقاط بنجاح!\nكود القسيمة: ${coupon}\nأعطِ هذا الكود للعميل ليستخدمه في طلبه القادم.`);
                    renderCustomers();
                }
            } else {
                alert('عذراً، لا يمتلك العميل نقاط كافية (الحد الأدنى 100 نقطة).');
            }
        }

        function renderOrders() {
            const tableBody = document.getElementById('orders-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            const encryptedOrders = localStorage.getItem('misk_orders_vault');
            const orders = DataVault.decrypt(encryptedOrders) || mockOrders;

            orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${order.id}</td>
                    <td>${order.date}</td>
                    <td>${order.customer}</td>
                    <td>${order.city}</td>
                    <td>${order.total}</td>
                    <td>
                        <select class="status-select" onchange="updateStatus('${order.id}', this.value)">
                            <option value="waiting" ${order.status === 'waiting' ? 'selected' : ''}>بانتظار التأكيد</option>
                            <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>قيد التجهيز</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>تم الشحن</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>تم التوصيل</option>
                        </select>
                    </td>
                    <td style="text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <button onclick="viewDetails('${order.id}')" title="عرض التفاصيل" style="background:none; border:none; cursor:pointer;">
                            <i class="fas fa-eye" style="color: #6a1b9a; font-size: 1.1rem;"></i>
                        </button>
                        <button onclick="contactWhatsApp('${order.id}')" title="تواصل عبر واتساب" class="btn-whatsapp-icon">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function updateStatus(orderId, newStatus) {
            const order = mockOrders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                alert(`تم تحديث حالة الطلب #${orderId} إلى: ${statusMap[newStatus]}`);
            }
        }

        function viewDetails(orderId) {
            const order = mockOrders.find(o => o.id === orderId);
            if (order) {
                document.getElementById('modal-order-number').innerText = `تفاصيل الطلب #${order.id}`;
                document.getElementById('detail-name').innerText = order.customer;
                document.getElementById('detail-whatsapp').innerText = order.whatsapp;
                document.getElementById('detail-city').innerText = order.city;
                document.getElementById('detail-date').innerText = order.date;
                document.getElementById('detail-address').innerText = order.address;
                document.getElementById('detail-total').innerText = order.total;
                const badge = document.getElementById('detail-status-badge');
                badge.className = `status-badge status-${order.status}`;
                badge.innerText = statusMap[order.status];
                document.getElementById('order-modal').style.display = 'flex';
            }
        }

        function contactWhatsApp(orderId) {
            const order = mockOrders.find(o => o.id === orderId);
            if (order) {
                const cleanPhone = order.whatsapp.replace(/\D/g, '');
                const message = `أهلاً بكِ في مسك بيوتي، نؤكد استلام طلبك رقم ${order.id}. هل العنوان المذكور ( ${order.address} ) دقيق للبدء بالتجهيز؟`;
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }
        }

        // --- Product Management Logic ---

        async function renderProducts() {
            const tableBody = document.getElementById('products-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';

            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                if (data.success) {
                    mockProducts = data.products;
                }
            } catch (e) {
                console.warn("API Fetch failed, using local storage fallback for products:", e);
                const localData = localStorage.getItem('misk_products');
                if (localData) mockProducts = JSON.parse(localData);
            }

            // Update Product Form Category Dropdowns based on current categories (even if empty)
            updateProductCategoryDropdowns();

            const sortedProducts = [...mockProducts].sort((a, b) => (b.priority || 0) - (a.priority || 0));

            if (sortedProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">لا يوجد منتجات متاحة.</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            sortedProducts.forEach(prod => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${prod.images && prod.images[0] ? prod.images[0] : ''}" class="product-thumb" onerror="this.src='https://placehold.co/50x50?text=Logo'"></td>
                    <td>${prod.name}</td>
                    <td>${prod.category}</td>
                    <td>
                        ${prod.originalPrice ? `<span style="text-decoration: line-through; color: #888; font-size: 0.8rem;">${prod.originalPrice}</span> ` : ''}
                        <span>${prod.price} شيكل</span>
                    </td>
                    <td>${prod.stock}</td>
                    <td>
                        <button onclick="openProductModal(${prod.id || "'" + prod._id + "'"})" style="background:none; border:none; cursor:pointer; color: #2e7d32; margin-left: 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProduct(${prod.id || "'" + prod._id + "'"})" style="background:none; border:none; cursor:pointer; color: #d32f2f;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- Category Management Logic ---
        async function renderCategories() {
            const tableBody = document.getElementById('categories-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';

            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                if (data.success) {
                    mockCategories = data.categories;
                    console.log("Categories loaded from API:", mockCategories);
                }
            } catch (e) {
                console.warn("API Fetch failed, using local storage fallback for categories:", e);
                const localData = localStorage.getItem('misk_categories');
                if (localData) mockCategories = JSON.parse(localData);
            }

            // Hierarchical sorting (Parents first, then their children)
            const sortedCategories = [];
            const parents = mockCategories.filter(c => !c.parentId);
            parents.sort((a, b) => (b.priority || 0) - (a.priority || 0));

            parents.forEach(p => {
                sortedCategories.push(p);
                const pId = p._id || p.id;
                // Fix: Exact comparison to avoid null == undefined matching parents
                const children = mockCategories.filter(c => c.parentId && c.parentId == pId);
                children.sort((a, b) => (b.priority || 0) - (a.priority || 0));
                children.forEach(c => {
                    c.isChild = true;
                    sortedCategories.push(c);
                });
            });

            if (sortedCategories.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">لا يوجد تصنيفات متاحة.</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            sortedCategories.forEach(cat => {
                const currentCatId = cat._id || cat.id;
                const parentName = cat.parentId ? (mockCategories.find(c => (c._id || c.id) == cat.parentId)?.name || '-') : 'رئيسي';
                const tr = document.createElement('tr');
                const isShown = String(cat.showInHeader) === 'true' || cat.showInHeader === true;
                tr.innerHTML = `
                    <td><img src="${cat.image || 'https://placehold.co/40x40?text=Cat'}" style="width: 40px; height: 40px; border-radius: 5px; object-fit: cover;"></td>
                    <td style="${cat.isChild ? 'padding-right: 30px;' : 'font-weight: bold;'}">
                        ${cat.isChild ? '<i class="fas fa-level-down-alt fa-rotate-180" style="color: #ccc; margin-left: 5px;"></i>' : ''} ${cat.name}
                    </td>
                    <td>${parentName}</td>
                    <td>${isShown ? '<span style="color: green;">نعم</span>' : '<span style="color: red;">لا</span>'}</td>
                    <td>${cat.priority || 0}</td>
                    <td>
                        <button onclick="openCategoryModal(${cat.id || "'" + cat._id + "'"})" style="background:none; border:none; cursor:pointer; color: #2e7d32; margin-left: 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCategory(${cat.id || "'" + cat._id + "'"})" style="background:none; border:none; cursor:pointer; color: #d32f2f;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function openCategoryModal(id = null) {
            const form = document.getElementById('category-form');
            form.reset();
            document.getElementById('category-id').value = id || '';
            document.getElementById('category-modal-title').innerText = id ? 'تعديل التصنيف' : 'إضافة تصنيف جديد';
            document.getElementById('cat-image-preview').innerHTML = '';
            catImageBase64 = null;
            catQuill.setContents([]);

            // Populate Parent Dropdown
            const parentSelect = document.getElementById('cat-parent');
            parentSelect.innerHTML = '<option value="">بدون (تصنيف رئيسي)</option>';

            console.log("Populating dropdown, Total Categories:", mockCategories.length);

            // Robust filter for potential parents
            const potentialParents = mockCategories.filter(c => {
                // Is root? (Null, empty, "null", or 0)
                const isRoot = !c.parentId || c.parentId === 'null' || c.parentId === "" || c.parentId === "0" || c.parentId === 0;
                // Prevent selecting self
                const isNotSelf = id ? (String(c._id) !== String(id) && String(c.id) !== String(id)) : true;
                return isRoot && isNotSelf;
            });

            console.log("Found Parents:", potentialParents.length);

            potentialParents.forEach(p => {
                const pId = p._id || p.id;
                parentSelect.innerHTML += `<option value="${pId}">${p.name}</option>`;
            });

            if (id) {
                const cat = mockCategories.find(c => String(c.id) === String(id) || String(c._id) === String(id));
                if (cat) {
                    document.getElementById('cat-name').value = cat.name;
                    if (document.getElementById('cat-slug')) document.getElementById('cat-slug').value = cat.slug || '';
                    document.getElementById('cat-parent').value = cat.parentId || '';
                    document.getElementById('cat-priority').value = cat.priority || 0;
                    document.getElementById('cat-show-header').value = cat.showInHeader;
                    if (cat.image) {
                        catImageBase64 = cat.image;
                        document.getElementById('cat-image-preview').innerHTML = `<img src="${cat.image}" style="max-width: 100px; border-radius: 8px;">`;
                    }
                    catQuill.clipboard.dangerouslyPasteHTML(cat.staticHeader || '');
                }
            }
            document.getElementById('category-modal').style.display = 'flex';
        }

        // --- Page Management Logic ---
        let pageQuill;
        let mockPages = JSON.parse(localStorage.getItem('misk_pages')) || [
            { id: 1, title: 'من نحن', slug: 'about-us', content: '<p>نحن متجر مسك بيوتي المتخصص في أرقى العطور ومنتجات العناية.</p>', isActive: true },
            { id: 2, title: 'الأسئلة الشائعة', slug: 'faq', content: '<p>هنا تجد إجابات على أكثر الأسئلة شيوعاً.</p>', isActive: true },
            { id: 3, title: 'سياسة الخصوصية', slug: 'privacy', content: '<p>تحترم مسك بيوتي خصوصيتكم وتلتزم بحمايتها.</p>', isActive: true },
            { id: 4, title: 'سياسة الإرجاع', slug: 'returns', content: '<p>يمكن إرجاع المنتجات خلال 7 أيام من الاستلام بشرط أن تكون بحالتها الأصلية.</p>', isActive: true }
        ];

        async function renderPages() {
            const tableBody = document.getElementById('pages-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';

            try {
                const response = await fetch('/api/pages');
                const data = await response.json();
                if (data.success) {
                    mockPages = data.pages;
                }
            } catch (e) {
                console.error("Error fetching pages:", e);
            }

            if (mockPages.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">لا يوجد صفحات متاحة.</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            mockPages.forEach(page => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${page.title}</td>
                    <td>/page.html?slug=${page.slug}</td>
                    <td>${page.isActive ? '<span class="status-badge" style="background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 5px; font-size: 0.8rem;">نشط</span>' : '<span class="status-badge" style="background: #f5f5f5; color: #666; padding: 4px 8px; border-radius: 5px; font-size: 0.8rem;">مسودة</span>'}</td>
                    <td>
                        <button onclick="openPageModal(${page.id || "'" + page._id + "'"})" style="background:none; border:none; cursor:pointer; color: #2e7d32; margin-left: 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deletePage(${page.id || "'" + page._id + "'"})" style="background:none; border:none; cursor:pointer; color: #d32f2f;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function openPageModal(id = null) {
            const form = document.getElementById('page-form');
            form.reset();
            document.getElementById('page-id').value = id || '';
            document.getElementById('page-modal-title').innerText = id ? 'تعديل الصفحة' : 'إضافة صفحة جديدة';
            pageQuill.setContents([]);

            if (id) {
                const page = mockPages.find(p => p.id == id || p._id == id);
                if (page) {
                    document.getElementById('page-title').value = page.title;
                    document.getElementById('page-slug').value = page.slug;
                    document.getElementById('page-is-active').checked = page.isActive || false;
                    pageQuill.clipboard.dangerouslyPasteHTML(page.content || '');
                }
            }
            document.getElementById('page-modal').style.display = 'flex';
        }

        async function handlePageSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('page-id').value;
            const newPage = {
                id: id && !isNaN(id) ? parseInt(id) : undefined,
                _id: id && isNaN(id) ? id : undefined,
                title: document.getElementById('page-title').value,
                slug: document.getElementById('page-slug').value,
                isActive: document.getElementById('page-is-active').checked,
                content: pageQuill.root.innerHTML
            };

            try {
                const sessionData = localStorage.getItem('misk_admin_session');
                if (!sessionData) {
                    alert('خطأ: لم يتم العثور على جلسة الإدارة. يرجى تسجيل الدخول مجدداً.');
                    window.location.href = 'admin-login.html';
                    return;
                }
                const token = JSON.parse(sessionData).token;
                if (!token) {
                    alert('خطأ: توكن الوصول مفقود. يرجى تسجيل الدخول مجدداً.');
                    window.location.href = 'admin-login.html';
                    return;
                }

                const method = id ? 'PUT' : 'POST';
                const response = await fetch('/api/pages', {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(newPage)
                });

                if (response.ok) {
                    alert(id ? 'تم تحديث الصفحة بنجاح' : 'تم إضافة الصفحة بنجاح');
                    closeModal('page-modal');
                    renderPages();
                } else {
                    let errorMessage = 'Unknown Error';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (parseError) {
                        errorMessage = await response.text() || response.statusText;
                    }
                    alert('خطأ في حفظ الصفحة: ' + errorMessage);
                }
            } catch (e) {
                console.error("Error saving page:", e);
                alert('فشل الاتصال بالخادم: ' + e.message);
            }
        }

        async function deletePage(id) {
            if (confirm('هل أنت متأكد من حذف هذه الصفحة؟')) {
                try {
                    const sessionData = localStorage.getItem('misk_admin_session');
                    if (!sessionData) throw new Error('يرجى تسجيل الدخول مجدداً (الجلسة مفقودة)');
                    const token = JSON.parse(sessionData).token;

                    const response = await fetch(`/api/pages?id=${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        renderPages();
                    } else {
                        let errorMessage = 'Unknown Error';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorMessage;
                        } catch (parseError) {
                            errorMessage = await response.text() || response.statusText;
                        }
                        alert('خطأ في حذف الصفحة: ' + errorMessage);
                    }
                } catch (e) {
                    console.error("Error deleting page:", e);
                    alert('فشل الاتصال بالخادم: ' + e.message);
                }
            }
        }

        async function handleCategorySubmit(e) {
            e.preventDefault();
            const id = document.getElementById('category-id').value;
            let slug = document.getElementById('cat-slug') ? document.getElementById('cat-slug').value : '';
            const name = document.getElementById('cat-name').value;

            // Auto-generate slug if parameters missing
            if (!slug || slug.trim() === '') {
                slug = generateSlug(name);
            }

            const newCat = {
                id: id && !isNaN(id) ? parseInt(id) : undefined,
                _id: id && isNaN(id) ? id : undefined,
                name: name,
                slug: slug,
                parentId: document.getElementById('cat-parent').value || null,
                priority: parseInt(document.getElementById('cat-priority').value) || 0,
                showInHeader: document.getElementById('cat-show-header').value,
                image: catImageBase64,
                staticHeader: catQuill.root.innerHTML
            };

            try {
                const sessionData = localStorage.getItem('misk_admin_session');
                if (!sessionData) {
                    alert('خطأ: لم يتم العثور على جلسة الإدارة. يرجى تسجيل الدخول مجدداً.');
                    window.location.href = 'admin-login.html';
                    return;
                }
                const token = JSON.parse(sessionData).token;
                if (!token) {
                    alert('خطأ: توكن الوصول مفقود. يرجى تسجيل الدخول مجدداً.');
                    window.location.href = 'admin-login.html';
                    return;
                }

                const method = id ? 'PUT' : 'POST';
                const response = await fetch('/api/categories', {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(newCat)
                });

                if (response.ok) {
                    alert(id ? 'تم تحديث التصنيف بنجاح' : 'تم إضافة التصنيف بنجاح');
                    closeModal('category-modal');
                    renderCategories();
                    updateProductCategoryDropdowns();
                } else {
                    let errorMessage = 'Unknown Error';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (parseError) {
                        errorMessage = await response.text() || response.statusText;
                    }
                    alert('خطأ في حفظ التصنيف: ' + errorMessage);
                }
            } catch (e) {
                console.error("Error saving category:", e);
                alert('فشل الاتصال بالخادم: ' + e.message);
            }
        }

        function generateSlug(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\u0600-\u06FF\-]+/g, '')       // Remove all non-word chars (accepting Arabic)
                .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start of text
                .replace(/-+$/, '');            // Trim - from end of text
        }

        async function deleteCategory(id) {
            if (confirm('هل أنت متأكد من حذف هذا التصنيف؟ سيتم فك ارتباط الفروع به.')) {
                try {
                    const sessionData = localStorage.getItem('misk_admin_session');
                    if (!sessionData) throw new Error('يرجى تسجيل الدخول مجدداً (الجلسة مفقودة)');
                    const token = JSON.parse(sessionData).token;

                    const response = await fetch(`/api/categories?id=${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        renderCategories();
                        updateProductCategoryDropdowns();
                    } else {
                        let errorMessage = 'Unknown Error';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorMessage;
                        } catch (parseError) {
                            errorMessage = await response.text() || response.statusText;
                        }
                        alert('خطأ في حذف التصنيف: ' + errorMessage);
                    }
                } catch (e) {
                    console.error("Error deleting category:", e);
                    alert('فشل الاتصال بالخادم: ' + e.message);
                }
            }
        }

        // --- Settings Management ---
        let storeSettings = {
            name: "مسك بيوتي",
            whatsapp: "+970599000000",
            description: "مسك بيوتي - وجهتكم الأولى لأرقى العطور ومنتجات العناية والجمال. نحن نجمع بين الجودة والفخامة لنقدم لكم الأفضل دائماً.",
            instagram: "",
            tiktok: "",
            facebook: "",
            logo: null,
            freeShippingThreshold: 300,
            metaTitle: "مسك بيوتي | Misk Beauty",
            metaDescription: "أفضل العطور ومنتجات العناية والجمال في مكان واحد.",
            metaKeywords: "عطور, مسك, تجميل, عناية",
            privacyPolicy: "",
            termsOfUse: "",
            pointsExpiryDays: 365,
            pointsPerReview: 50
        };

        function renderAnalytics() {
            const encryptedOrders = localStorage.getItem('misk_orders_vault');
            const orders = DataVault.decrypt(encryptedOrders) || [];

            // Collect all orders including mock data if vault is empty
            let allOrders = orders;
            if (orders.length === 0) allOrders = mockOrders;

            let totalRevenue = 0;
            let orderCount = allOrders.length;
            let productSales = {}; // {name: {qty, revenue}}
            let categorySales = {}; // {name: revenue}

            allOrders.forEach(order => {
                const revenueStr = order.total.replace(/[^\d.]/g, '');
                const revenue = parseFloat(revenueStr) || 0;
                totalRevenue += revenue;

                if (order.items) {
                    order.items.forEach(item => {
                        // Product Tally
                        if (!productSales[item.name]) productSales[item.name] = { qty: 0, revenue: 0 };
                        productSales[item.name].qty += item.qty;
                        productSales[item.name].revenue += (item.price * item.qty);

                        // Category Tally
                        const cat = item.category || 'عام';
                        if (!categorySales[cat]) categorySales[cat] = 0;
                        categorySales[cat] += (item.price * item.qty);
                    });
                }
            });

            const aov = orderCount > 0 ? (totalRevenue / orderCount).toFixed(1) : 0;

            // Update Stat Cards
            document.getElementById('ana-total-revenue').textContent = `${totalRevenue.toLocaleString()} شيكل`;
            document.getElementById('ana-order-count').textContent = orderCount;
            document.getElementById('ana-aov').textContent = `${aov} شيكل`;

            // Render Top Products
            const topProductsList = document.getElementById('ana-top-products');
            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1].qty - a[1].qty)
                .slice(0, 5);

            topProductsList.innerHTML = sortedProducts.length > 0
                ? sortedProducts.map(([name, data]) => `
                    <li style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f9f9f9;">
                        <span>${name}</span>
                        <span style="font-weight: 700; color: #6a1b9a;">${data.qty} قطعة</span>
                    </li>
                `).join('')
                : '<li style="color: #888; text-align: center; padding: 10px;">لا توجد بيانات تفصيلية متوفرة حالياً.</li>';

            // Render Category Performance
            const topCategoriesList = document.getElementById('ana-top-categories');
            const sortedCategories = Object.entries(categorySales)
                .sort((a, b) => b[1] - a[1]);

            topCategoriesList.innerHTML = sortedCategories.length > 0
                ? sortedCategories.map(([name, rev]) => `
                    <li style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f9f9f9;">
                        <span>${name}</span>
                        <span style="font-weight: 700;">${rev} شيكل</span>
                    </li>
                `).join('')
                : '<li style="color: #888; text-align: center; padding: 10px;">لا توجد بيانات تفصيلية متوفرة حالياً.</li>';

            // Loyalty Insights
            const encryptedUsers = localStorage.getItem('misk_users_vault');
            const users = DataVault.decrypt(encryptedUsers) || [];
            let pointsEarned = 0;
            let pointsRedeemed = 0;

            users.forEach(u => {
                if (u.pointsHistory) {
                    u.pointsHistory.forEach(h => {
                        if (h.amount > 0) pointsEarned += h.amount;
                    });
                }
                pointsRedeemed += (u.redeemedTotal || 0);
            });

            document.getElementById('ana-points-earned').textContent = pointsEarned;
            document.getElementById('ana-points-redeemed').textContent = pointsRedeemed;
        }

        function exportSalesDataCSV() {
            const encryptedOrders = localStorage.getItem('misk_orders_vault');
            const orders = DataVault.decrypt(encryptedOrders) || [];

            if (orders.length === 0) {
                alert('لا يوجد طلبات في الوقت الحالي لتصديرها.');
                return;
            }

            let csv = 'ID,Date,Customer,Phone,City,Address,Total,Status\n';
            orders.forEach(o => {
                csv += `"${o.id}","${o.date}","${o.customer}","${o.whatsapp}","${o.city}","${o.address}","${o.total}","${o.status}"\n`;
            });

            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `تقرير_مبيعات_مسك_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
        }

        async function renderSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                if (data.success && data.settings) {
                    storeSettings = data.settings;
                }
            } catch (e) {
                console.error("Error fetching settings:", e);
            }

            document.getElementById('set-store-name').value = storeSettings.name || "";
            document.getElementById('set-whatsapp').value = storeSettings.whatsapp || "";
            document.getElementById('set-store-desc').value = storeSettings.description || "";
            document.getElementById('set-instagram').value = storeSettings.instagram || "";
            document.getElementById('set-tiktok').value = storeSettings.tiktok || "";
            document.getElementById('set-facebook').value = storeSettings.facebook || "";
            document.getElementById('set-meta-title').value = storeSettings.metaTitle || "";
            document.getElementById('set-meta-desc').value = storeSettings.metaDescription || "";
            document.getElementById('set-meta-keywords').value = storeSettings.metaKeywords || "";
            document.getElementById('set-points-expiry').value = storeSettings.pointsExpiryDays || 365;
            document.getElementById('set-points-review').value = storeSettings.pointsPerReview || 50;

            if (privacyQuill) privacyQuill.clipboard.dangerouslyPasteHTML(storeSettings.privacyPolicy || "");
            if (termsQuill) termsQuill.clipboard.dangerouslyPasteHTML(storeSettings.termsOfUse || "");

            if (storeSettings.logo) {
                document.getElementById('logo-preview').innerHTML = `<img src="${storeSettings.logo}" style="max-height: 80px; border-radius: 8px;">`;
            }
        }

        function previewLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    storeSettings.logo = e.target.result;
                    document.getElementById('logo-preview').innerHTML = `<img src="${e.target.result}" style="max-height: 80px; border-radius: 8px;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function handleSettingsSubmit(e) {
            e.preventDefault();
            const updated = {
                ...storeSettings,
                name: document.getElementById('set-store-name').value,
                whatsapp: document.getElementById('set-whatsapp').value,
                description: document.getElementById('set-store-desc').value,
                instagram: document.getElementById('set-instagram').value,
                tiktok: document.getElementById('set-tiktok').value,
                facebook: document.getElementById('set-facebook').value,
                freeShippingThreshold: parseInt(document.getElementById('set-free-shipping-threshold').value) || 0,
                metaTitle: document.getElementById('set-meta-title').value,
                metaDescription: document.getElementById('set-meta-desc').value,
                metaKeywords: document.getElementById('set-meta-keywords').value,
                pointsExpiryDays: parseInt(document.getElementById('set-points-expiry').value) || 365,
                pointsPerReview: parseInt(document.getElementById('set-points-review').value) || 50,
                privacyPolicy: privacyQuill.root.innerHTML,
                termsOfUse: termsQuill.root.innerHTML
            };

            try {
                const sessionData = localStorage.getItem('misk_admin_session');
                if (!sessionData) throw new Error('No session data');
                const token = JSON.parse(sessionData).token;

                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updated)
                });

                if (response.ok) {
                    storeSettings = updated;
                    alert('تم حفظ الإعدادات بنجاح وسيتم تطبيقها في الموقع.');
                } else {
                    let errorMessage = 'Unknown Error';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (parseError) {
                        errorMessage = await response.text() || response.statusText;
                    }
                    alert('خطأ في حفظ الإعدادات: ' + errorMessage);
                }
            } catch (e) {
                console.error("Error saving settings:", e);
                alert('فشل الاتصال بالخادم: ' + e.message);
            }
        }

        function updateProductCategoryDropdowns() {
            const mainSel = document.getElementById('prod-category');
            const subSel = document.getElementById('prod-sub-category');

            if (!mainSel || !subSel) return;

            mainSel.innerHTML = '';
            subSel.innerHTML = '<option value="">بدون تصنيف فرعي</option>';

            const parents = mockCategories.filter(c => !c.parentId);
            parents.forEach(p => {
                mainSel.innerHTML += `<option value="${p.name}">${p.name}</option>`;
                const pId = p._id || p.id;
                const children = mockCategories.filter(c => c.parentId == pId);
                if (children.length > 0) {
                    let group = `<optgroup label="${p.name}">`;
                    children.forEach(c => {
                        group += `<option value="${c.name}">${c.name}</option>`;
                    });
                    group += `</optgroup>`;
                    subSel.innerHTML += group;
                }
            });
        }


        function syncParentCategory() {
            const subVal = document.getElementById('prod-sub-category').value;
            const subCatObj = mockCategories.find(c => c.name == subVal && c.parentId);
            if (subCatObj) {
                const searchId = subCatObj.parentId;
                const parentCat = mockCategories.find(c => (c._id || c.id) == searchId);
                if (parentCat) {
                    document.getElementById('prod-category').value = parentCat.name;
                }
            }
        }

        function openProductModal(id = null) {
            const form = document.getElementById('product-form');
            form.reset();
            document.getElementById('product-id').value = id || '';
            document.getElementById('product-modal-title').innerText = id ? 'تعديل المنتج' : 'إضافة منتج جديد';

            // Reset Advanced Fields
            document.getElementById('image-preview-container').innerHTML = '';
            document.getElementById('variant-items-list').innerHTML = '';
            uploadedImagesBase64 = [];
            quill.setContents([]);

            if (id) {
                const prod = mockProducts.find(p => p.id == id || p._id == id);
                if (prod) {
                    document.getElementById('prod-name').value = prod.name;
                    document.getElementById('prod-slug').value = prod.slug || '';
                    document.getElementById('prod-meta-title').value = prod.metaTitle || '';
                    document.getElementById('prod-meta-desc').value = prod.metaDesc || '';
                    document.getElementById('prod-original-price').value = prod.originalPrice || '';
                    document.getElementById('prod-price').value = prod.price;
                    document.getElementById('prod-stock').value = prod.stock;
                    document.getElementById('prod-priority').value = prod.priority || 0;
                    document.getElementById('prod-category').value = prod.category;
                    document.getElementById('prod-sub-category').value = prod.subCategory || '';

                    // Load Images
                    if (prod.images) {
                        prod.images.forEach(img => {
                            uploadedImagesBase64.push(img);
                            const div = document.createElement('div');
                            div.className = 'preview-item';
                            div.innerHTML = `
                                <img src="${img}">
                                <button type="button" onclick="removePreview(this, '${img}')" class="remove-p">&times;</button>
                            `;
                            document.getElementById('image-preview-container').appendChild(div);
                        });
                    }

                    // Load Variants v2
                    if (prod.variants) {
                        prod.variants.forEach(v => addVariantItem(v));
                    }

                    // Load Rich Text
                    quill.clipboard.dangerouslyPasteHTML(prod.desc || '');
                }
            }

            document.getElementById('product-modal').style.display = 'flex';
        }

        async function handleProductSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const newProd = {
                id: id && !isNaN(id) ? parseInt(id) : undefined,
                _id: id && isNaN(id) ? id : undefined,
                name: document.getElementById('prod-name').value,
                slug: document.getElementById('prod-slug').value,
                metaTitle: document.getElementById('prod-meta-title').value,
                metaDesc: document.getElementById('prod-meta-desc').value,
                originalPrice: document.getElementById('prod-original-price').value ? parseInt(document.getElementById('prod-original-price').value) : null,
                price: parseInt(document.getElementById('prod-price').value),
                stock: parseInt(document.getElementById('prod-stock').value),
                priority: parseInt(document.getElementById('prod-priority').value) || 0,
                category: document.getElementById('prod-category').value,
                subCategory: document.getElementById('prod-sub-category').value,
                images: uploadedImagesBase64,
                variants: getVariantsData(),
                desc: quill.root.innerHTML
            };

            // Client-side Validation
            if (uploadedImagesBase64.length === 0) {
                alert('خطأ: يجب إضافة صورة واحدة على الأقل للمنتج');
                return;
            }

            // Show Loading State
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الرفع والحفظ...';
            submitBtn.disabled = true;

            try {
                const sessionData = localStorage.getItem('misk_admin_session');
                if (!sessionData) {
                    alert('خطأ: لم يتم العثور على جلسة الإدارة. يرجى تسجيل الدخول مجدداً.');
                    window.location.href = 'admin-login.html';
                    return;
                }
                const token = JSON.parse(sessionData).token;
                if (!token) {
                    alert('خطأ: توكن الوصول مفقود. يرجى تسجيل الدخول مجدداً.');
                    window.location.href = 'admin-login.html';
                    return;
                }

                // 1. Upload Images to Cloudinary via API
                const imageUrls = [];
                for (const base64Img of uploadedImagesBase64) {
                    // Check if it's already a URL (existing image)
                    if (base64Img.startsWith('http')) {
                        imageUrls.push(base64Img);
                        continue;
                    }

                    // Upload new image
                    const uploadRes = await fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            file: base64Img,
                            folder: 'misk_products'
                        })
                    });

                    const uploadData = await uploadRes.json();
                    if (!uploadData.success) {
                        throw new Error('فشل رفع الصورة: ' + uploadData.message);
                    }
                    imageUrls.push(uploadData.url);
                }

                // 2. Prepare Product Data with URLs
                const newProd = {
                    id: id && !isNaN(id) ? parseInt(id) : undefined,
                    _id: id && isNaN(id) ? id : undefined,
                    name: document.getElementById('prod-name').value,
                    slug: document.getElementById('prod-slug').value,
                    metaTitle: document.getElementById('prod-meta-title').value,
                    metaDesc: document.getElementById('prod-meta-desc').value,
                    originalPrice: document.getElementById('prod-original-price').value ? parseInt(document.getElementById('prod-original-price').value) : null,
                    price: parseInt(document.getElementById('prod-price').value),
                    stock: parseInt(document.getElementById('prod-stock').value),
                    priority: parseInt(document.getElementById('prod-priority').value) || 0,
                    category: document.getElementById('prod-category').value,
                    subCategory: document.getElementById('prod-sub-category').value,
                    images: imageUrls, // Send URLs now
                    variants: getVariantsData(),
                    desc: quill.root.innerHTML
                };

                const method = id ? 'PUT' : 'POST';
                const response = await fetch('/api/products', {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(newProd)
                });

                let data = {};
                try {
                    data = await response.json();
                } catch (pe) {
                    const text = await response.text();
                    data = { message: text || response.statusText };
                }

                if (response.ok) {
                    alert(id ? 'تم القحديث بنجاح' : 'تم الإضافة بنجاح');
                    closeModal('product-modal');
                    renderProducts();
                } else {
                    console.error("Server Error:", data);
                    alert('خطأ في حفظ المنتج: ' + (data.message || 'Unknown Server Error'));
                }
            } catch (e) {
                console.error("Error saving product:", e);
                alert('فشل العملية: ' + e.message);
            } finally {
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        }

        async function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                try {
                    const sessionData = localStorage.getItem('misk_admin_session');
                    if (!sessionData) throw new Error('يرجى تسجيل الدخول مجدداً (الجلسة مفقودة)');
                    const token = JSON.parse(sessionData).token;

                    const response = await fetch(`/api/products?id=${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        renderProducts();
                    } else {
                        let errorMessage = 'Unknown Error';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorMessage;
                        } catch (parseError) {
                            errorMessage = await response.text() || response.statusText;
                        }
                        alert('خطأ في حذف المنتج: ' + errorMessage);
                    }
                } catch (e) {
                    console.error("Error deleting product:", e);
                    alert('فشل الاتصال بالخادم: ' + e.message);
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- Session & Init ---
        function verifyAdminSession() {
            const sessionDataString = localStorage.getItem('misk_admin_session');
            if (!sessionDataString) {
                window.location.href = 'admin-login.html';
                return;
            }
            const sessionData = JSON.parse(sessionDataString);
            const now = Date.now();
            const sessionHours = (now - sessionData.loginTime) / (1000 * 60 * 60);

            if (!sessionData.persistent && sessionHours > 2) {
                localStorage.removeItem('misk_admin_session');
                window.location.href = 'admin-login.html';
                return;
            }

            if (sessionHours > 24) {
                localStorage.removeItem('misk_admin_session');
                window.location.href = 'admin-login.html';
                return;
            }
        }

        // Initialize
        async function initDashboard() {
            verifyAdminSession();

            // Load essential data from API
            try {
                const [catRes, setRes] = await Promise.all([
                    fetch('/api/categories').then(r => r.json()),
                    fetch('/api/settings').then(r => r.json())
                ]);

                if (catRes.success) {
                    mockCategories = catRes.categories;
                    localStorage.setItem('misk_categories', JSON.stringify(catRes.categories));
                }
                if (setRes.success && setRes.settings) {
                    storeSettings = setRes.settings;
                    localStorage.setItem('misk_settings', JSON.stringify(setRes.settings));
                }
            } catch (e) {
                console.warn("API Fetch failed, using local storage fallback:", e);
                const localCats = localStorage.getItem('misk_categories');
                const localSettings = localStorage.getItem('misk_settings');
                if (localCats) mockCategories = JSON.parse(localCats);
                if (localSettings) storeSettings = JSON.parse(localSettings);
            }

            // Trigger initial renders
            renderOrders();
            renderProducts();
            renderCategories();
            renderPages();

            // Log for debug
            console.log("Dashboard fully initialized with Categories:", mockCategories.length);
        }

        // Initialize Page Editor
        pageQuill = new Quill('#page-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });
    </script>
</body>

</html>