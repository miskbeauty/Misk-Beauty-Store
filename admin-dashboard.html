<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | مسك بيوتي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Quill.js for Rich Text -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/admin.css">
</head>

<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar">
            <div class="sidebar-logo">
                <img src="assets/images/1745215944148877862-removebg-preview.png" alt="Misk Beauty Logo">
                <h3 style="color: #6a1b9a; font-size: 0.9rem; margin-top: 10px;">إدارة مسك بيوتي</h3>
            </div>

            <ul class="sidebar-menu">
                <li class="menu-item active" id="menu-orders">
                    <a href="#" onclick="switchTab('orders')">
                        <i class="fas fa-shopping-bag"></i>
                        <span>إدارة الطلبات</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-products">
                    <a href="#" onclick="switchTab('products')">
                        <i class="fas fa-box-open"></i>
                        <span>إدارة المنتجات</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-categories">
                    <a href="#" onclick="switchTab('categories')">
                        <i class="fas fa-list-ul"></i>
                        <span>إدارة التصنيفات</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#">
                        <i class="fas fa-users"></i>
                        <span>العملاء</span>
                    </a>
                </li>
                <li class="menu-item" id="menu-settings">
                    <a href="#" onclick="switchTab('settings')">
                        <i class="fas fa-cog"></i>
                        <span>الإعدادات</span>
                    </a>
                </li>
                <li class="menu-item" style="margin-top: 50px;">
                    <a href="admin-login.html" onclick="localStorage.removeItem('misk_admin_session')">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>تسجيل الخروج</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content Area -->
        <main class="admin-main">
            <!-- Top Header -->
            <header class="dashboard-header">
                <div>
                    <h1 style="font-size: 1.8rem; font-weight: 700;">أهلاً بك، المدير</h1>
                    <p style="color: #636e72;">نظرة عامة على نشاط المتجر اليوم.</p>
                </div>

                <div class="admin-user-info">
                    <div class="user-details" style="text-align: left;">
                        <span style="display: block; font-weight: 700;">أحمد محمد</span>
                        <span style="font-size: 0.8rem; color: #888;">مدير المتجر</span>
                    </div>
                    <div class="user-avatar">AD</div>
                </div>
            </header>

            <!-- Quick Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-purple">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-info">
                        <h4>إجمالي الطلبات</h4>
                        <span>124</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon bg-pink">
                        <i class="fas fa-shekel-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h4>المبيعات (شيكل)</h4>
                        <span>4,820</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon bg-gold">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="stat-info">
                        <h4>زوار اليوم</h4>
                        <span>352</span>
                    </div>
                </div>
            </section>

            <!-- Orders Management Table -->
            <section id="orders-section" class="admin-card">
                <div class="card-header">
                    <h3 style="font-weight: 700;">إدارة الطلبات</h3>
                    <div class="header-actions">
                        <button class="btn-admin-login"
                            style="padding: 8px 15px; font-size: 0.9rem; width: auto; box-shadow: none;">تصدير
                            البيانات</button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>التاريخ</th>
                                <th>الاسم</th>
                                <th>المنطقة/المدينة</th>
                                <th>الإجمالي</th>
                                <th>الحالة</th>
                                <th>العمليات</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Product Management Table -->
            <section id="products-section" class="admin-card hidden">
                <div class="card-header">
                    <h3 style="font-weight: 700;">إدارة المنتجات</h3>
                    <div class="header-actions">
                        <button onclick="openProductModal()" class="btn-admin-login"
                            style="padding: 8px 15px; font-size: 0.9rem; width: auto; box-shadow: none;">
                            <i class="fas fa-plus"></i> إضافة منتج جديد
                        </button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>صورة المنتج</th>
                                <th>الاسم</th>
                                <th>التصنيف</th>
                                <th>السعر</th>
                                <th>المخزون</th>
                                <th>العمليات</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Category Management Table -->
            <section id="categories-section" class="admin-card hidden">
                <!-- ... existing content ... -->
                <div class="card-header">
                    <h3 style="font-weight: 700;">إدارة التصنيفات</h3>
                    <div class="header-actions">
                        <button onclick="openCategoryModal()" class="btn-admin-login"
                            style="padding: 8px 15px; font-size: 0.9rem; width: auto; box-shadow: none;">
                            <i class="fas fa-plus"></i> إضافة تصنيف جديد
                        </button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>أيقونة/صورة</th>
                                <th>الاسم</th>
                                <th>التصنيف الأب</th>
                                <th>في الهيدر</th>
                                <th>الأولوية</th>
                                <th>العمليات</th>
                            </tr>
                        </thead>
                        <tbody id="categories-table-body">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="admin-card hidden">
                <div class="card-header">
                    <h3 style="font-weight: 700;">إعدادات المتجر</h3>
                </div>

                <form id="settings-form" onsubmit="handleSettingsSubmit(event)">
                    <div class="details-grid">
                        <div class="admin-form-group">
                            <label>اسم المتجر</label>
                            <input type="text" id="set-store-name" class="admin-input" placeholder="مثلاً: مسك بيوتي">
                        </div>
                        <div class="admin-form-group">
                            <label>رقم الواتساب (للتواصل والطلبات)</label>
                            <input type="text" id="set-whatsapp" class="admin-input" placeholder="+970xxxxxxxxx">
                        </div>
                        <div class="admin-form-group">
                            <label>رابط انستجرام</label>
                            <input type="text" id="set-instagram" class="admin-input"
                                placeholder="https://instagram.com/...">
                        </div>
                        <div class="admin-form-group">
                            <label>رابط تيك توك</label>
                            <input type="text" id="set-tiktok" class="admin-input" placeholder="https://tiktok.com/...">
                        </div>
                        <div class="admin-form-group full-width">
                            <label>شعار المتجر (Logo)</label>
                            <input type="file" id="set-logo-input" class="admin-input" accept="image/*"
                                onchange="previewLogo(this)">
                            <div id="logo-preview" style="margin-top: 10px;"></div>
                        </div>

                        <div class="full-width"
                            style="margin-top: 20px; border-top: 2px solid #f0f0f0; padding-top: 20px;">
                            <h4 style="color: var(--admin-purple); margin-bottom: 15px;">إعدادات الشحن وتكاليف التوصيل
                            </h4>
                        </div>

                        <div class="admin-form-group">
                            <label>حد الشحن المجاني (شيكل)</label>
                            <input type="number" id="set-free-shipping-threshold" class="admin-input" placeholder="300">
                        </div>
                        <div class="admin-form-group">
                            <label>رابط فيسبوك</label>
                            <input type="text" id="set-facebook" class="admin-input"
                                placeholder="https://facebook.com/...">
                        </div>
                    </div>

                    <div style="margin-top: 30px; text-align: left;">
                        <button type="submit" class="btn-admin-login" style="width: auto; padding: 12px 40px;">حفظ
                            الإعدادات</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-order-number">تفاصيل الطلب</h3>
                <button class="close-modal" onclick="closeModal('order-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">اسم العميل</span>
                        <span class="detail-value" id="detail-name">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">رقم الواتساب</span>
                        <span class="detail-value" id="detail-whatsapp">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">المدينة/المنطقة</span>
                        <span class="detail-value" id="detail-city">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">التاريخ</span>
                        <span class="detail-value" id="detail-date">-</span>
                    </div>
                    <div class="detail-item full-width">
                        <span class="detail-label">العنوان بالتفصيل</span>
                        <span class="detail-value" id="detail-address">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">المبلغ الإجمالي</span>
                        <span class="detail-value" id="detail-total">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">الحالة الحالية</span>
                        <span id="detail-status-badge" class="status-badge">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal (Add/Edit) -->
    <div id="product-modal" class="modal-overlay">
        <!-- ... existing product modal content ... -->
        <div class="modal-content" style="max-width: 850px;">
            <div class="modal-header">
                <h3 id="product-modal-title">إضافة منتج جديد</h3>
                <button class="close-modal" onclick="closeModal('product-modal')">&times;</button>
            </div>
            <form id="product-form" onsubmit="handleProductSubmit(event)">
                <input type="hidden" id="product-id">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 10px;">
                    <div class="details-grid">
                        <!-- ... existing grid content ... -->
                        <div class="admin-form-group">
                            <label>اسم المنتج</label>
                            <input type="text" id="prod-name" class="admin-input" required
                                placeholder="مثلاً: عطر مسك فاخر">
                        </div>
                        <div class="admin-form-group">
                            <label>رابط SEO (Slug)</label>
                            <input type="text" id="prod-slug" class="admin-input"
                                placeholder="مثلاً: luxury-musk-perfume">
                        </div>
                        <div class="admin-form-group full-width">
                            <label>وصف الميتا (SEO Meta Description)</label>
                            <textarea id="prod-meta-desc" class="admin-input" style="min-height: 60px;"
                                placeholder="اكتب وصفاً مختصراً يظهر في محركات البحث..."></textarea>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>صور المنتج (يمكنك اختيار عدة صور)</label>
                            <div class="image-upload-wrapper">
                                <input type="file" id="prod-images-input" class="admin-input" accept="image/*" multiple
                                    onchange="previewImages(this)">
                                <div id="image-preview-container" class="image-preview-grid"></div>
                            </div>
                        </div>
                        <div class="admin-form-group">
                            <label>السعر الأصلي (شيكل)</label>
                            <input type="number" id="prod-original-price" class="admin-input" placeholder="120">
                        </div>
                        <div class="admin-form-group">
                            <label>سعر العرض (شيكل)</label>
                            <input type="number" id="prod-price" class="admin-input" required placeholder="99">
                        </div>
                        <div class="admin-form-group">
                            <label>المخزون الإجمالي</label>
                            <input type="number" id="prod-stock" class="admin-input" required placeholder="50">
                        </div>
                        <div class="admin-form-group">
                            <label>أولوية الظهور (Priority)</label>
                            <input type="number" id="prod-priority" class="admin-input" value="0">
                        </div>
                        <div class="admin-form-group">
                            <label>التصنيف الرئيسي</label>
                            <select id="prod-category" class="admin-input" required>
                                <option value="عناية وجمال">عناية وجمال</option>
                                <option value="عطور">عطور</option>
                                <option value="شنط وإكسسوارات">شنط وإكسسوارات</option>
                                <option value="الأطفال والبيبي">الأطفال والبيبي</option>
                                <option value="الطباعة الحرارية">الطباعة الحرارية</option>
                                <option value="منتجات طبية">منتجات طبية</option>
                                <option value="المنزل والديكور">المنزل والديكور</option>
                                <option value="الهدايا">الهدايا</option>
                            </select>
                        </div>
                        <div class="admin-form-group">
                            <label>التصنيف الفرعي</label>
                            <select id="prod-sub-category" class="admin-input" onchange="syncParentCategory()">
                                <option value="">بدون تصنيف فرعي</option>
                                <optgroup label="عناية وجمال">
                                    <option value="مكياج">مكياج</option>
                                    <option value="عناية بالبشرة">عناية بالبشرة</option>
                                    <option value="شعر">شعر</option>
                                    <option value="جسم">جسم</option>
                                </optgroup>
                                <optgroup label="عطور">
                                    <option value="ستاتي">ستاتي</option>
                                    <option value="رجالي">رجالي</option>
                                    <option value="مزيل عرق">مزيل عرق</option>
                                    <option value="عطر شعر">عطر شعر</option>
                                    <option value="بخور">بخور</option>
                                </optgroup>
                                <optgroup label="شنط وإكسسوارات">
                                    <option value="شنط">شنط</option>
                                    <option value="إكسسوارات ستاتي">إكسسوارات ستاتي</option>
                                    <option value="رجالي">إكسسوارات رجالي</option>
                                </optgroup>
                                <optgroup label="الأطفال والبيبي">
                                    <option value="مستلزمات">مستلزمات</option>
                                    <option value="إكسسوارات">إكسسوارات بيبي</option>
                                </optgroup>
                                <optgroup label="الطباعة الحرارية">
                                    <option value="براويز">براويز</option>
                                    <option value="مجات">مجات</option>
                                    <option value="لهايات وبلايز">لهايات وبلايز</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="admin-form-group full-width"
                            style="margin-top: 20px; border-top: 2px solid #f0f0f0; padding-top: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="color: var(--admin-purple);">تعدد الخيارات (Variants)</h4>
                                <button type="button" onclick="addVariantItem()" class="btn-cancel"
                                    style="padding: 5px 15px; font-size: 0.85rem; background: var(--admin-purple); color: white;">
                                    <i class="fas fa-plus"></i> إضافة خيار محدد (درجة/لون)
                                </button>
                            </div>
                            <div id="variants-v2-container">
                                <div id="variants-header"
                                    style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 40px; gap: 10px; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; color: #777;">
                                    <span>اسم الخيار (مثلاً: درجة 1)</span>
                                    <span>سعر أصلي</span>
                                    <span>سعر عرض</span>
                                    <span>مخزون</span>
                                    <span>SKU</span>
                                    <span></span>
                                </div>
                                <div id="variant-items-list"></div>
                            </div>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>وصف المنتج التفصيلي (طريقة الاستخدام، المكونات، إلخ)</label>
                            <div id="editor-container" style="height: 200px; background: #fff;"></div>
                            <textarea id="prod-desc" style="display:none;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('product-modal')">إلغاء</button>
                    <button type="submit" class="btn-admin-login" style="width: auto; padding: 10px 30px;">حفظ
                        المنتج</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal (Add/Edit) -->
    <div id="category-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 850px;">
            <div class="modal-header">
                <h3 id="category-modal-title">إضافة تصنيف جديد</h3>
                <button class="close-modal" onclick="closeModal('category-modal')">&times;</button>
            </div>
            <form id="category-form" onsubmit="handleCategorySubmit(event)">
                <input type="hidden" id="category-id">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 10px;">
                    <div class="details-grid">
                        <div class="admin-form-group">
                            <label>اسم التصنيف</label>
                            <input type="text" id="cat-name" class="admin-input" required
                                placeholder="مثلاً: عطور فرنسية">
                        </div>
                        <div class="admin-form-group">
                            <label>التصنيف الأب (Hierarchy)</label>
                            <select id="cat-parent" class="admin-input">
                                <option value="">بدون (تصنيف رئيسي)</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="admin-form-group">
                            <label>أولوية الترتيب</label>
                            <input type="number" id="cat-priority" class="admin-input" value="0">
                        </div>
                        <div class="admin-form-group">
                            <label>ظهور في الهيدر الرئيسي؟</label>
                            <select id="cat-show-header" class="admin-input">
                                <option value="true">نعم</option>
                                <option value="false">لا</option>
                            </select>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>صورة التصنيف</label>
                            <input type="file" id="cat-image-input" class="admin-input" accept="image/*"
                                onchange="previewCatImage(this)">
                            <div id="cat-image-preview" style="margin-top: 10px;"></div>
                        </div>
                        <div class="admin-form-group full-width">
                            <label>محتوى رأس القسم (SEO & Static Content)</label>
                            <div id="cat-editor-container" style="height: 150px; background: #fff;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('category-modal')">إلغاء</button>
                    <button type="submit" class="btn-admin-login" style="width: auto; padding: 10px 30px;">حفظ
                        التصنيف</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quill.js scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // Global variables for Advanced Mode
        let quill;
        let catQuill; // New Quill for categories
        let uploadedImagesBase64 = [];
        let catImageBase64 = null;
        let mockCategories = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Init Product Quill
            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'direction': 'rtl' }, { 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'اكتب وصف المنتج هنا...'
            });

            // Init Category Quill
            catQuill = new Quill('#cat-editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'المحتوى الذي سيظهر في رأس الصفحة...'
            });
        });

        // --- Multi-Image Logic ---
        function previewImages(input) {
            const container = document.getElementById('image-preview-container');
            container.innerHTML = '';
            uploadedImagesBase64 = [];

            if (input.files) {
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        uploadedImagesBase64.push(e.target.result);
                        const div = document.createElement('div');
                        div.className = 'preview-item';
                        div.innerHTML = `
                            <img src="${e.target.result}">
                            <button type="button" onclick="removePreview(this, '${e.target.result}')" class="remove-p">&times;</button>
                        `;
                        container.appendChild(div);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        function removePreview(btn, src) {
            uploadedImagesBase64 = uploadedImagesBase64.filter(img => img !== src);
            btn.parentElement.remove();
        }

        // --- Category Image Logic ---
        function previewCatImage(input) {
            const container = document.getElementById('cat-image-preview');
            container.innerHTML = '';
            catImageBase64 = null;

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    catImageBase64 = e.target.result;
                    container.innerHTML = `<img src="${catImageBase64}" style="max-width: 100px; border-radius: 8px;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- Variants Logic v2 ---
        function addVariantItem(data = {}) {
            const list = document.getElementById('variant-items-list');
            const div = document.createElement('div');
            div.className = 'variant-v2-row';
            div.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 40px; gap: 10px; margin-bottom: 10px; align-items: center;';

            div.innerHTML = `
                <input type="text" class="admin-input var-v2-label" placeholder="درجة 1" value="${data.label || ''}">
                <input type="number" class="admin-input var-v2-orig" placeholder="0" value="${data.originalPrice || ''}">
                <input type="number" class="admin-input var-v2-price" placeholder="0" value="${data.price || ''}">
                <input type="number" class="admin-input var-v2-stock" placeholder="0" value="${data.stock || ''}">
                <input type="text" class="admin-input var-v2-sku" placeholder="SKU" value="${data.sku || ''}">
                <button type="button" onclick="this.parentElement.remove()" style="color: red; background: none; border: none; font-size: 1.2rem; cursor: pointer;">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            list.appendChild(div);
        }

        function getVariantsData() {
            const rows = document.querySelectorAll('.variant-v2-row');
            const variants = [];
            rows.forEach(row => {
                const label = row.querySelector('.var-v2-label').value.trim();
                const originalPrice = row.querySelector('.var-v2-orig').value;
                const price = row.querySelector('.var-v2-price').value;
                const stock = row.querySelector('.var-v2-stock').value;
                const sku = row.querySelector('.var-v2-sku').value.trim();

                if (label) {
                    variants.push({
                        label,
                        originalPrice: originalPrice ? parseInt(originalPrice) : null,
                        price: price ? parseInt(price) : 0,
                        stock: stock ? parseInt(stock) : 0,
                        sku
                    });
                }
            });
            return variants;
        }

        // --- Mock Data ---
        let mockOrders = [
            { id: "10521", date: "2024-01-29", customer: "ياسر الأحمد", whatsapp: "+970 599 123 456", city: "عقربا، نابلس", address: "شارع المدارس، عمارة الأمل، ط2", total: "120 شيكل", status: "waiting" },
            { id: "10522", date: "2024-01-28", customer: "سارة محمود", whatsapp: "+970 568 987 654", city: "القدس، شارع الزهراء", address: "فوق صيدلية القدس، شقة 4", total: "315 شيكل", status: "preparing" }
        ];

        let mockProducts = [
            { id: 1, name: "عطر مسك فاخر", category: "عطور", price: 85, stock: 24, images: ["assets/images/perfume-sample.jpg"], variants: [] }
        ];

        const statusMap = {
            'waiting': 'بانتظار التأكيد',
            'preparing': 'قيد التجهيز',
            'shipped': 'تم الشحن',
            'delivered': 'تم التوصيل'
        };

        // --- Core Functions ---
        function switchTab(tab) {
            const sections = ['orders-section', 'products-section', 'categories-section', 'settings-section'];
            const menuItems = ['menu-orders', 'menu-products', 'menu-categories', 'menu-settings'];

            sections.forEach(s => document.getElementById(s).classList.add('hidden'));
            menuItems.forEach(m => document.getElementById(m).classList.remove('active'));

            document.getElementById(`${tab}-section`).classList.remove('hidden');
            document.getElementById(`menu-${tab}`).classList.add('active');

            if (tab === 'orders') renderOrders();
            if (tab === 'products') renderProducts();
            if (tab === 'categories') renderCategories();
            if (tab === 'settings') renderSettings();
        }

        function renderOrders() {
            const tableBody = document.getElementById('orders-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            mockOrders.forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${order.id}</td>
                    <td>${order.date}</td>
                    <td>${order.customer}</td>
                    <td>${order.city}</td>
                    <td>${order.total}</td>
                    <td>
                        <select class="status-select" onchange="updateStatus('${order.id}', this.value)">
                            <option value="waiting" ${order.status === 'waiting' ? 'selected' : ''}>بانتظار التأكيد</option>
                            <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>قيد التجهيز</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>تم الشحن</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>تم التوصيل</option>
                        </select>
                    </td>
                    <td style="text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <button onclick="viewDetails('${order.id}')" title="عرض التفاصيل" style="background:none; border:none; cursor:pointer;">
                            <i class="fas fa-eye" style="color: #6a1b9a; font-size: 1.1rem;"></i>
                        </button>
                        <button onclick="contactWhatsApp('${order.id}')" title="تواصل عبر واتساب" class="btn-whatsapp-icon">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function updateStatus(orderId, newStatus) {
            const order = mockOrders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                alert(`تم تحديث حالة الطلب #${orderId} إلى: ${statusMap[newStatus]}`);
            }
        }

        function viewDetails(orderId) {
            const order = mockOrders.find(o => o.id === orderId);
            if (order) {
                document.getElementById('modal-order-number').innerText = `تفاصيل الطلب #${order.id}`;
                document.getElementById('detail-name').innerText = order.customer;
                document.getElementById('detail-whatsapp').innerText = order.whatsapp;
                document.getElementById('detail-city').innerText = order.city;
                document.getElementById('detail-date').innerText = order.date;
                document.getElementById('detail-address').innerText = order.address;
                document.getElementById('detail-total').innerText = order.total;
                const badge = document.getElementById('detail-status-badge');
                badge.className = `status-badge status-${order.status}`;
                badge.innerText = statusMap[order.status];
                document.getElementById('order-modal').style.display = 'flex';
            }
        }

        function contactWhatsApp(orderId) {
            const order = mockOrders.find(o => o.id === orderId);
            if (order) {
                const cleanPhone = order.whatsapp.replace(/\D/g, '');
                const message = `أهلاً بكِ في مسك بيوتي، نؤكد استلام طلبك رقم ${order.id}. هل العنوان المذكور ( ${order.address} ) دقيق للبدء بالتجهيز؟`;
                const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }
        }

        // --- Product Management Logic ---

        function renderProducts() {
            const tableBody = document.getElementById('products-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            // Update Product Form Category Dropdowns based on dynamic categories
            updateProductCategoryDropdowns();

            const sortedProducts = [...mockProducts].sort((a, b) => (b.priority || 0) - (a.priority || 0));

            sortedProducts.forEach(prod => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${prod.images && prod.images[0] ? prod.images[0] : ''}" class="product-thumb" onerror="this.src='https://placehold.co/50x50?text=Logo'"></td>
                    <td>${prod.name}</td>
                    <td>${prod.category}</td>
                    <td>
                        ${prod.originalPrice ? `<span style="text-decoration: line-through; color: #888; font-size: 0.8rem;">${prod.originalPrice}</span> ` : ''}
                        <span>${prod.price} شيكل</span>
                    </td>
                    <td>${prod.stock}</td>
                    <td>
                        <button onclick="openProductModal(${prod.id})" style="background:none; border:none; cursor:pointer; color: #2e7d32; margin-left: 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteProduct(${prod.id})" style="background:none; border:none; cursor:pointer; color: #d32f2f;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- Category Management Logic ---
        function renderCategories() {
            const tableBody = document.getElementById('categories-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            // Hierarchical sorting (Parents first, then their children)
            const sortedCategories = [];
            const parents = mockCategories.filter(c => !c.parentId);
            parents.sort((a, b) => (b.priority || 0) - (a.priority || 0));

            parents.forEach(p => {
                sortedCategories.push(p);
                const children = mockCategories.filter(c => c.parentId == p.id);
                children.sort((a, b) => (b.priority || 0) - (a.priority || 0));
                children.forEach(c => {
                    c.isChild = true;
                    sortedCategories.push(c);
                });
            });

            sortedCategories.forEach(cat => {
                const parentName = cat.parentId ? (mockCategories.find(c => c.id == cat.parentId)?.name || '-') : 'رئيسي';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${cat.image || 'https://placehold.co/40x40?text=Cat'}" style="width: 40px; height: 40px; border-radius: 5px; object-fit: cover;"></td>
                    <td style="${cat.isChild ? 'padding-right: 30px;' : 'font-weight: bold;'}">
                        ${cat.isChild ? '<i class="fas fa-level-down-alt fa-rotate-180" style="color: #ccc; margin-left: 5px;"></i>' : ''} ${cat.name}
                    </td>
                    <td>${parentName}</td>
                    <td>${cat.showInHeader == 'true' ? '<span style="color: green;">نعم</span>' : '<span style="color: red;">لا</span>'}</td>
                    <td>${cat.priority || 0}</td>
                    <td>
                        <button onclick="openCategoryModal(${cat.id})" style="background:none; border:none; cursor:pointer; color: #2e7d32; margin-left: 10px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCategory(${cat.id})" style="background:none; border:none; cursor:pointer; color: #d32f2f;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function openCategoryModal(id = null) {
            const form = document.getElementById('category-form');
            form.reset();
            document.getElementById('category-id').value = id || '';
            document.getElementById('category-modal-title').innerText = id ? 'تعديل التصنيف' : 'إضافة تصنيف جديد';
            document.getElementById('cat-image-preview').innerHTML = '';
            catImageBase64 = null;
            catQuill.setContents([]);

            // Populate Parent Dropdown
            const parentSelect = document.getElementById('cat-parent');
            parentSelect.innerHTML = '<option value="">بدون (تصنيف رئيسي)</option>';
            mockCategories.filter(c => !c.parentId && c.id != id).forEach(p => {
                parentSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });

            if (id) {
                const cat = mockCategories.find(c => c.id == id);
                if (cat) {
                    document.getElementById('cat-name').value = cat.name;
                    document.getElementById('cat-parent').value = cat.parentId || '';
                    document.getElementById('cat-priority').value = cat.priority || 0;
                    document.getElementById('cat-show-header').value = cat.showInHeader;
                    if (cat.image) {
                        catImageBase64 = cat.image;
                        document.getElementById('cat-image-preview').innerHTML = `<img src="${cat.image}" style="max-width: 100px; border-radius: 8px;">`;
                    }
                    catQuill.clipboard.dangerouslyPasteHTML(cat.staticHeader || '');
                }
            }
            document.getElementById('category-modal').style.display = 'flex';
        }

        function handleCategorySubmit(e) {
            e.preventDefault();
            const id = document.getElementById('category-id').value;
            const newCat = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('cat-name').value,
                parentId: document.getElementById('cat-parent').value ? parseInt(document.getElementById('cat-parent').value) : null,
                priority: parseInt(document.getElementById('cat-priority').value) || 0,
                showInHeader: document.getElementById('cat-show-header').value,
                image: catImageBase64,
                staticHeader: catQuill.root.innerHTML
            };

            if (id) {
                const index = mockCategories.findIndex(c => c.id == parseInt(id));
                mockCategories[index] = newCat;
            } else {
                mockCategories.push(newCat);
            }

            localStorage.setItem('misk_categories', JSON.stringify(mockCategories));
            closeModal('category-modal');
            renderCategories();
        }

        function deleteCategory(id) {
            if (confirm('هل أنت متأكد من حذف هذا التصنيف؟ سيتم فك ارتباط الفروع به.')) {
                mockCategories = mockCategories.filter(c => c.id != id);
                // Also update children to have no parent
                mockCategories.forEach(c => {
                    if (c.parentId == id) c.parentId = null;
                });
                localStorage.setItem('misk_categories', JSON.stringify(mockCategories));
                renderCategories();
            }
        }

        // --- Settings Management ---
        let storeSettings = {
            name: "مسك بيوتي",
            whatsapp: "+970599000000",
            instagram: "",
            tiktok: "",
            facebook: "",
            logo: null,
            freeShippingThreshold: 300
        };

        function renderSettings() {
            const saved = localStorage.getItem('misk_settings');
            if (saved) storeSettings = JSON.parse(saved);

            document.getElementById('set-store-name').value = storeSettings.name || "";
            document.getElementById('set-whatsapp').value = storeSettings.whatsapp || "";
            document.getElementById('set-instagram').value = storeSettings.instagram || "";
            document.getElementById('set-tiktok').value = storeSettings.tiktok || "";
            document.getElementById('set-facebook').value = storeSettings.facebook || "";
            document.getElementById('set-free-shipping-threshold').value = storeSettings.freeShippingThreshold || 300;

            if (storeSettings.logo) {
                document.getElementById('logo-preview').innerHTML = `<img src="${storeSettings.logo}" style="max-height: 80px; border-radius: 8px;">`;
            }
        }

        function previewLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    storeSettings.logo = e.target.result;
                    document.getElementById('logo-preview').innerHTML = `<img src="${e.target.result}" style="max-height: 80px; border-radius: 8px;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleSettingsSubmit(e) {
            e.preventDefault();
            storeSettings.name = document.getElementById('set-store-name').value;
            storeSettings.whatsapp = document.getElementById('set-whatsapp').value;
            storeSettings.instagram = document.getElementById('set-instagram').value;
            storeSettings.tiktok = document.getElementById('set-tiktok').value;
            storeSettings.facebook = document.getElementById('set-facebook').value;
            storeSettings.freeShippingThreshold = parseInt(document.getElementById('set-free-shipping-threshold').value);

            localStorage.setItem('misk_settings', JSON.stringify(storeSettings));
            alert('تم حفظ الإعدادات بنجاح وسيتم تطبيقها في الموقع.');
        }

        function updateProductCategoryDropdowns() {
            const mainSel = document.getElementById('prod-category');
            const subSel = document.getElementById('prod-sub-category');

            if (!mainSel || !subSel) return;

            mainSel.innerHTML = '';
            subSel.innerHTML = '<option value="">بدون تصنيف فرعي</option>';

            const parents = mockCategories.filter(c => !c.parentId);
            parents.forEach(p => {
                mainSel.innerHTML += `<option value="${p.name}">${p.name}</option>`;

                const children = mockCategories.filter(c => c.parentId == p.id);
                if (children.length > 0) {
                    let group = `<optgroup label="${p.name}">`;
                    children.forEach(c => {
                        group += `<option value="${c.name}">${c.name}</option>`;
                    });
                    group += `</optgroup>`;
                    subSel.innerHTML += group;
                }
            });
        }


        function syncParentCategory() {
            const subVal = document.getElementById('prod-sub-category').value;
            const subCatObj = mockCategories.find(c => c.name == subVal && c.parentId);
            if (subCatObj) {
                const parentCat = mockCategories.find(c => c.id == subCatObj.parentId);
                if (parentCat) {
                    document.getElementById('prod-category').value = parentCat.name;
                }
            }
        }

        function openProductModal(id = null) {
            const form = document.getElementById('product-form');
            form.reset();
            document.getElementById('product-id').value = id || '';
            document.getElementById('product-modal-title').innerText = id ? 'تعديل المنتج' : 'إضافة منتج جديد';

            // Reset Advanced Fields
            document.getElementById('image-preview-container').innerHTML = '';
            document.getElementById('variant-items-list').innerHTML = '';
            uploadedImagesBase64 = [];
            quill.setContents([]);

            if (id) {
                const prod = mockProducts.find(p => p.id === id);
                if (prod) {
                    document.getElementById('prod-name').value = prod.name;
                    document.getElementById('prod-slug').value = prod.slug || '';
                    document.getElementById('prod-meta-desc').value = prod.metaDesc || '';
                    document.getElementById('prod-original-price').value = prod.originalPrice || '';
                    document.getElementById('prod-price').value = prod.price;
                    document.getElementById('prod-stock').value = prod.stock;
                    document.getElementById('prod-priority').value = prod.priority || 0;
                    document.getElementById('prod-category').value = prod.category;
                    document.getElementById('prod-sub-category').value = prod.subCategory || '';

                    // Load Images
                    if (prod.images) {
                        prod.images.forEach(img => {
                            uploadedImagesBase64.push(img);
                            const div = document.createElement('div');
                            div.className = 'preview-item';
                            div.innerHTML = `
                                <img src="${img}">
                                <button type="button" onclick="removePreview(this, '${img}')" class="remove-p">&times;</button>
                            `;
                            document.getElementById('image-preview-container').appendChild(div);
                        });
                    }

                    // Load Variants v2
                    if (prod.variants) {
                        prod.variants.forEach(v => addVariantItem(v));
                    }

                    // Load Rich Text
                    quill.clipboard.dangerouslyPasteHTML(prod.desc || '');
                }
            }

            document.getElementById('product-modal').style.display = 'flex';
        }

        function handleProductSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const newProd = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('prod-name').value,
                slug: document.getElementById('prod-slug').value,
                metaDesc: document.getElementById('prod-meta-desc').value,
                originalPrice: document.getElementById('prod-original-price').value ? parseInt(document.getElementById('prod-original-price').value) : null,
                price: parseInt(document.getElementById('prod-price').value),
                stock: parseInt(document.getElementById('prod-stock').value),
                priority: parseInt(document.getElementById('prod-priority').value) || 0,
                category: document.getElementById('prod-category').value,
                subCategory: document.getElementById('prod-sub-category').value,
                images: uploadedImagesBase64,
                variants: getVariantsData(),
                desc: quill.root.innerHTML
            };

            if (id) {
                const index = mockProducts.findIndex(p => p.id === parseInt(id));
                mockProducts[index] = newProd;
                alert('تم التحديث بنجاح');
            } else {
                mockProducts.push(newProd);
                alert('تم الإضافة بنجاح');
            }

            // --- PERSISTENCE ---
            localStorage.setItem('misk_products', JSON.stringify(mockProducts));

            closeModal('product-modal');
            renderProducts();
        }

        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                mockProducts = mockProducts.filter(p => p.id !== id);
                localStorage.setItem('misk_products', JSON.stringify(mockProducts));
                renderProducts();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- Session & Init ---
        function verifyAdminSession() {
            const sessionDataString = localStorage.getItem('misk_admin_session');
            if (!sessionDataString) {
                window.location.href = 'admin-login.html';
                return;
            }
            const sessionData = JSON.parse(sessionDataString);
            const now = Date.now();
            const sessionHours = (now - sessionData.loginTime) / (1000 * 60 * 60);

            if (!sessionData.persistent && sessionHours > 2) {
                localStorage.removeItem('misk_admin_session');
                window.location.href = 'admin-login.html';
                return;
            }

            if (sessionHours > 24) {
                localStorage.removeItem('misk_admin_session');
                window.location.href = 'admin-login.html';
                return;
            }
        }

        // Initialize
        window.onclick = function (event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = 'none';
            }
        }

        // Load persisted data
        const savedProds = localStorage.getItem('misk_products');
        if (savedProds) mockProducts = JSON.parse(savedProds);

        const savedCats = localStorage.getItem('misk_categories');
        if (savedCats) {
            mockCategories = JSON.parse(savedCats);
        } else {
            // Initial Seed if empty
            mockCategories = [
                { id: 1, name: "عناية وجمال", parentId: null, priority: 10, showInHeader: "true", image: null, staticHeader: "" },
                { id: 2, name: "عطور", parentId: null, priority: 9, showInHeader: "true", image: null, staticHeader: "" },
                { id: 3, name: "مكياج", parentId: 1, priority: 0, showInHeader: "true", image: null, staticHeader: "" },
                { id: 4, name: "Perfumes", parentId: null, priority: 8, showInHeader: "true", image: null, staticHeader: "<h1>Perfumes Section</h1><p>Explore our exclusive collection of premium perfumes.</p>" },
                { id: 5, name: "French Perfumes", parentId: 4, priority: 0, showInHeader: "true", image: null, staticHeader: "<h1>French Perfumes</h1><p>The finest scents from Paris.</p>" }
            ];
            localStorage.setItem('misk_categories', JSON.stringify(mockCategories));
        }

        verifyAdminSession();
        renderOrders();
        renderProducts();
        renderCategories();
    </script>
</body>

</html>